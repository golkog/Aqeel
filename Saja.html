<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Subscription Lady - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø·ÙˆØ±Ø©</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root {
      /* âœ… ÙˆØ§Ø¬Ù‡Ø© ÙˆØ±Ø¯ÙŠ Ø®ÙÙŠÙ */
      --primary: #ec4899;   /* pink-500 */
      --secondary: #f472b6; /* pink-400 */
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;

      --bg: #0b1220;        /* Ø£ØºÙ…Ù‚ Ø´ÙˆÙŠ */
      --card: #141c2e;      /* Ø£ØºÙ…Ù‚ Ù…Ø¹ Ù„Ù…Ø³Ø© ÙˆØ±Ø¯ÙŠ */
      --text: #f1f5f9;
      --input-bg: #1d2843;
    }

    * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; }

    body {
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .app-header {
      background: #141c2e;
      color: white;
      padding: 25px 20px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.35);
      border-bottom: 1px solid #243155;
    }
    .app-header h1 { margin: 0; font-size: 1.6rem; font-weight: 900; color: #f9a8d4; }
    .app-header p { margin: 5px 0 0; font-size: 0.9rem; opacity: 0.85; }

    .container { padding: 15px; flex: 1; padding-bottom: 90px; }

    .backup-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    .btn-backup {
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #243155;
      background: #141c2e;
      color: white;
      font-size: 0.85rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-export { border-color: var(--success); color: var(--success); }
    .btn-import { border-color: var(--secondary); color: var(--secondary); }

    .stats-bar {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 16px;
    }
    .stat-item {
      background: var(--card);
      padding: 15px 5px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid #243155;
    }
    .stat-item b { display: block; font-size: 1.1rem; color: #fff; margin-bottom: 4px; }
    .stat-item span { font-size: 0.75rem; color: #a7b0c6; font-weight: 700; }

    .form-card {
      background: var(--card);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 18px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.45);
      border: 1px solid #243155;
    }
    .form-card h2 {
      font-size: 1.1rem;
      margin-top: 0;
      margin-bottom: 15px;
      color: var(--primary);
      border-bottom: 1px solid #243155;
      padding-bottom: 10px;
    }

    .field { margin-bottom: 15px; }
    label { display: block; font-size: 0.85rem; font-weight: 700; margin-bottom: 6px; color: #cbd5e1; }
    input, select {
      width: 100%;
      padding: 14px;
      border: 1px solid #243155;
      border-radius: 12px;
      font-size: 1rem;
      background: var(--input-bg);
      color: white;
      transition: 0.3s;
    }
    input:focus, select:focus { border-color: var(--primary); outline: none; background: #223055; }

    .btn-main {
      width: 100%;
      padding: 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1.1rem;
      margin-top: 10px;
      box-shadow: 0 4px 10px rgba(236, 72, 153, 0.35);
      cursor: pointer;
    }

    .customer-card {
      background: var(--card);
      border-radius: 15px;
      padding: 18px;
      margin-bottom: 15px;
      position: relative;
      border-right: 5px solid var(--primary);
      border-top: 1px solid #243155;
      border-bottom: 1px solid #243155;
      border-left: 1px solid #243155;
    }
    .customer-card.special { border-right-color: var(--warning); background: #141c2e; }
    .customer-card.expired { border-right-color: var(--danger); opacity: 0.95; }
    .customer-card.warning-near { border-right-color: var(--warning); border-right-width: 8px; }

    .card-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .cust-name { font-weight: 800; font-size: 1.1rem; color: #fff; }
    .cust-service { font-size: 0.8rem; color: white; background: var(--primary); padding: 4px 10px; border-radius: 8px; }

    .card-info { font-size: 0.95rem; margin-bottom: 15px; line-height: 1.6; color: #cbd5e1; }
    .card-info b { color: #fff; }
    .email-text { font-size: 0.85rem; color: #f9a8d4; font-weight: 600; word-break: break-all; }

    .card-actions {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      border-top: 1px solid #243155;
      padding-top: 15px;
    }

    .action-btn {
      border: none;
      padding: 12px 0;
      border-radius: 10px;
      color: white;
      font-size: 0.85rem;
      font-weight: 700;
      text-align: center;
      cursor: pointer;
      user-select: none;
    }

    .bg-whatsapp { background: #16a34a; }
    .bg-contact { background: #22c55e; }
    .bg-pay { background: var(--success); }
    .bg-img { background: #7c3aed; }
    .bg-del { background: var(--danger); }
    .bg-edit { background: #0ea5e9; }
    .bg-warning { background: var(--warning); color: #000; }
    .bg-reminded { background: #10b981; color: #fff; }
    .bg-renew { background: #3b82f6; color: #fff; }

    .status-tag {
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 6px;
      margin-right: 5px;
    }
    .status-paid { background: #064e3b; color: #34d399; }
    .status-unpaid { background: #7f1d1d; color: #f87171; }
    .status-warning { background: #78350f; color: #fbbf24; }

    .reminder-banner {
      background: var(--warning);
      color: #000;
      text-align: center;
      font-weight: bold;
      font-size: 0.85rem;
      padding: 6px;
      border-radius: 8px;
      margin-bottom: 12px;
      animation: pulse 2s infinite;
    }
    .expired-banner {
      background: var(--danger);
      color: #fff;
      text-align: center;
      font-weight: bold;
      font-size: 0.85rem;
      padding: 6px;
      border-radius: 8px;
      margin-bottom: 12px;
      opacity: 0.95;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    #hidden-area {
      position: fixed;
      left: 0;
      top: 0;
      opacity: 0;
      pointer-events: none;
    }

    /* âœ… Ø§Ù„ÙˆØµÙ„: Ù„ÙˆÙ† Ù…Ø®ØªÙ„Ù Ø´ÙˆÙŠ (ÙˆØ±Ø¯ÙŠ/Ø¨Ù†ÙØ³Ø¬ÙŠ) + Ù†ÙØ³ ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· Ø§Ù„Ø³Ø§Ø¨Ù‚ */
    .receipt {
      width: 650px;
      background: linear-gradient(135deg, #2a1230 0%, #0b1220 55%, #1a1140 100%);
      color: #ffffff;
      padding: 45px;
      text-align: right;
      border: 6px solid #ec4899;
      border-radius: 30px;
    }
    .receipt h2 {
      color: #f9a8d4;
      text-align: center;
      margin-bottom: 28px;
      font-size: 2.7rem;
      font-weight: 900;
      border-bottom: 4px solid rgba(255,255,255,0.12);
      padding-bottom: 18px;
    }
    .receipt-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding-bottom: 10px;
      gap: 18px;
    }
    .receipt-row span {
      color: #fbcfe8;
      font-weight: 900;
      font-size: 1.35rem;
      min-width: 170px;
      opacity: 0.9;
    }
    .receipt-row b {
      color: #ffffff;
      font-size: 1.35rem;
      font-weight: 900;
    }

    .receipt-footer {
      text-align: center;
      margin-top: 34px;
      padding: 22px;
      background: rgba(236, 72, 153, 0.12);
      border-radius: 20px;
      border: 2px solid rgba(236, 72, 153, 0.35);
    }
    .contact-info {
      color: #34d399;
      font-size: 2.6rem;
      font-weight: 900;
      margin: 10px 0;
      display: block;
      direction: ltr;
    }
    .thank-you-msg {
      font-size: 1.7rem;
      color: #f1f5f9;
      margin-bottom: 8px;
      font-weight: 900;
    }
    .receipt-date {
      font-size: 1.05rem;
      color: #f9a8d4;
      font-weight: 900;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 14px;
    }
    .modal {
      width: min(720px, 100%);
      max-height: 88vh;
      overflow: auto;
      background: #0b1220;
      border: 1px solid #243155;
      border-radius: 18px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      padding: 16px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #243155;
    }
    .modal-title { font-weight: 900; color: #f9a8d4; font-size: 1.05rem; }
    .modal-close {
      background: transparent;
      border: 1px solid #243155;
      color: #cbd5e1;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 800;
    }
    .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 560px) { .modal-grid { grid-template-columns: 1fr; } }
    .modal-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 14px;
      padding-top: 12px;
      border-top: 1px solid #243155;
    }
    .btn-secondary {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: 1px solid #243155;
      background: #111b2e;
      color: #cbd5e1;
      font-weight: 900;
      cursor: pointer;
    }
    .btn-save {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: 0;
      background: var(--primary);
      color: #fff;
      font-weight: 900;
      cursor: pointer;
    }
    .mini-row {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 10px;
      border: 1px solid #243155;
      border-radius: 12px;
      background: #111b2e;
      margin-top: 10px;
    }
    .mini-row input[type="checkbox"]{ width: 18px; height: 18px; accent-color: var(--primary); }
    .mini-row span{ color: #cbd5e1; font-weight: 900; font-size: 0.9rem; }

    .tabs-bar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(11,18,32,0.92);
      backdrop-filter: blur(8px);
      border-top: 1px solid #243155;
      z-index: 999;
      padding: 10px 10px 12px;
    }
    .tabs {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      max-width: 900px;
      margin: 0 auto;
    }
    .tab-btn {
      position: relative;
      border: 1px solid #243155;
      background: #0b1220;
      border-radius: 14px;
      color: #cbd5e1;
      padding: 10px 8px;
      cursor: pointer;
      text-align: center;
      font-weight: 900;
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
      justify-content: center;
      user-select: none;
    }
    .tab-btn .icon { font-size: 1.2rem; line-height: 1; }
    .tab-btn .label { font-size: 0.78rem; }
    .tab-btn.active {
      border-color: rgba(236,72,153,0.7);
      box-shadow: 0 0 0 3px rgba(236,72,153,0.18);
      color: #fff;
    }
    .tab-badge {
      position: absolute;
      top: -7px;
      left: 10px;
      background: #111b2e;
      border: 1px solid #243155;
      color: #cbd5e1;
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 900;
      padding: 2px 8px;
      min-width: 24px;
      text-align: center;
    }
    .tab-badge.danger { border-color: rgba(239,68,68,0.55); color: #f87171; }
    .tab-badge.warning { border-color: rgba(245,158,11,0.55); color: #fbbf24; }
    .tab-badge.success { border-color: rgba(16,185,129,0.55); color: #34d399; }

    .filter-title {
      background: rgba(20,28,46,0.55);
      border: 1px solid #243155;
      border-radius: 16px;
      padding: 12px 14px;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .filter-title b { color: #fff; font-weight: 900; }
    .filter-title span { color: #a7b0c6; font-weight: 900; font-size: 0.85rem; }

    .empty {
      background: rgba(20,28,46,0.45);
      border: 1px dashed #243155;
      border-radius: 16px;
      padding: 14px;
      color: #a7b0c6;
      font-weight: 900;
      text-align: center;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <header class="app-header">
    <h1>Subscription Lady</h1>
    <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ø²Ø¨Ø§Ø¦Ù† Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</p>
  </header>

  <div class="container">
    <div class="backup-controls">
      <button class="btn-backup btn-export" onclick="exportData()">ğŸ“¥ Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
      <button class="btn-backup btn-import" onclick="document.getElementById('file-input').click()">ğŸ“¤ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø©</button>
      <input type="file" id="file-input" style="display:none" accept=".json" onchange="importData(event)" />
    </div>

    <div class="stats-bar">
      <div class="stat-item">
        <b id="stat-count">0</b>
        <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</span>
      </div>
      <div class="stat-item">
        <b id="stat-today-money" style="color:var(--primary)">0</b>
        <span>Ø¯Ø®Ù„ Ø§Ù„ÙŠÙˆÙ…</span>
      </div>
      <div class="stat-item">
        <b id="stat-money" style="color:var(--success)">0</b>
        <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ø§Ø®ÙŠÙ„</span>
      </div>
      <div class="stat-item" style="border-color: var(--danger);">
        <b id="stat-debt" style="color:var(--danger)">0</b>
        <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ† (Ù†Ø·Ù„Ø¨Ù‡Ù…)</span>
      </div>
      <div class="stat-item">
        <b id="stat-expired">0</b>
        <span>Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù…Ù†ØªÙ‡ÙŠØ©</span>
      </div>
      <div class="stat-item" style="border-color: var(--warning);">
        <b id="stat-need-reminder" style="color:var(--warning)">0</b>
        <span>ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ 3 Ø£ÙŠØ§Ù…</span>
      </div>
    </div>

    <div class="form-card">
      <h2>â• Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ Ø¬Ø¯ÙŠØ¯</h2>

      <div class="field">
        <label>Ø§Ù„Ø®Ø¯Ù…Ø©</label>
        <select id="f-service">
          <option value="ChatGPT Plus">ChatGPT Plus ğŸ¤–</option>
          <option value="Canva Pro">Canva Pro ğŸ¨</option>
          <option value="CapCut Pro">CapCut Pro ğŸ¬</option>
          <option value="Ø¹Ø¶ÙˆÙŠØ© â­">Ø¹Ø¶ÙˆÙŠØ© Ù…Ù…ÙŠØ²Ø© â­</option>
        </select>
      </div>

      <div class="field">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Space Name)</label>
        <input type="text" id="f-space" placeholder="Ù…Ø«Ø§Ù„: Family Group 1" />
      </div>

      <div class="field">
        <label>Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
        <input type="text" id="f-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" />
      </div>

      <div class="field">
        <label>Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</label>
        <input type="tel" id="f-phone" placeholder="07xxxxxxxxx" />
      </div>

      <div class="field">
        <label>Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø²Ø¨ÙˆÙ† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input type="email" id="f-email" placeholder="customer@example.com" style="direction:ltr; text-align:right;" />
      </div>

      <div class="field">
        <label>Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ø³Ø±ÙŠ - Ù„Ø§ ÙŠØ¸Ù‡Ø± Ù„Ù„Ø²Ø¨ÙˆÙ†)</label>
        <input type="email" id="f-space-email" placeholder="space@example.com" style="direction:ltr; text-align:right;" />
      </div>

      <div class="field">
        <label>Ø±Ù…Ø² / ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ø³Ø±ÙŠ - Ù„Ø§ ÙŠØ¸Ù‡Ø± Ù„Ù„Ø²Ø¨ÙˆÙ†)</label>
        <input type="text" id="f-space-code" placeholder="Ù…Ø«Ø§Ù„: P@ss1234" style="direction:ltr; text-align:right;" />
      </div>

      <div style="display:flex; gap:10px;">
        <div class="field" style="flex:1">
          <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯ÙŠÙ†Ø§Ø±)</label>
          <input type="number" id="f-price" value="10000" />
        </div>
        <div class="field" style="flex:1">
          <label>Ø§Ù„Ù…Ø¯Ø©</label>
          <select id="f-duration" disabled>
            <option value="1">Ø´Ù‡Ø±ÙŠ</option>
          </select>
        </div>
      </div>

      <div style="display:flex; gap:10px;">
        <div class="field" style="flex:1">
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</label>
          <input type="date" id="f-start" onchange="updateDate()" />
        </div>
        <div class="field" style="flex:1">
          <label>Ø§Ù„Ù†Ù‡Ø§ÙŠØ© (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</label>
          <input type="date" id="f-end" />
        </div>
      </div>

      <button class="btn-main" onclick="save()">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>

    <div class="search-area" style="display:flex; gap:8px; margin-bottom:14px;">
      <input type="text" id="q" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø­Ø©..." oninput="render()" style="padding:12px; flex:1" />
      <button style="padding:0 15px; border-radius:12px; border:1px solid #243155; background:var(--card); color:white;" onclick="render()">ğŸ”</button>
    </div>

    <div class="filter-title">
      <b id="filter-title">ÙƒÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</b>
      <span id="filter-subtitle">0</span>
    </div>

    <div id="list"></div>
  </div>

  <div id="hidden-area">
    <div id="receipt-box" class="receipt">
      <h2>Subscription Lady</h2>
      <div id="receipt-data"></div>
      <div class="receipt-footer">
        <div class="thank-you-msg">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø®ØªÙŠØ§Ø±ÙƒÙ… Subscription Lady âœ¨</div>
        <div style="font-size:1.45rem; color:#fbcfe8; font-weight:900;">Ù„Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ (ÙˆØ§ØªØ³Ø§Ø¨):</div>
        <div class="contact-info">07777646928</div>
        <div id="r-date" class="receipt-date"></div>
      </div>
    </div>
  </div>

  <div id="edit-overlay" class="modal-overlay" onclick="closeEditIfOutside(event)">
    <div class="modal" role="dialog" aria-modal="true" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ</div>
        <button class="modal-close" onclick="closeEdit()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>

      <div class="modal-grid">
        <div class="field">
          <label>Ø§Ù„Ø®Ø¯Ù…Ø©</label>
          <select id="e-service">
            <option value="ChatGPT Plus">ChatGPT Plus ğŸ¤–</option>
            <option value="Canva Pro">Canva Pro ğŸ¨</option>
            <option value="CapCut Pro">CapCut Pro ğŸ¬</option>
            <option value="Ø¹Ø¶ÙˆÙŠØ© â­">Ø¹Ø¶ÙˆÙŠØ© Ù…Ù…ÙŠØ²Ø© â­</option>
          </select>
        </div>

        <div class="field">
          <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯ÙŠÙ†Ø§Ø±)</label>
          <input type="number" id="e-price" />
        </div>

        <div class="field">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø­Ø©</label>
          <input type="text" id="e-space" />
        </div>

        <div class="field">
          <label>Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
          <input type="text" id="e-name" />
        </div>

        <div class="field">
          <label>Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</label>
          <input type="tel" id="e-phone" />
        </div>

        <div class="field">
          <label>Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
          <input type="email" id="e-email" style="direction:ltr; text-align:right;" />
        </div>

        <div class="field">
          <label>Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ø³Ø±ÙŠ)</label>
          <input type="email" id="e-space-email" style="direction:ltr; text-align:right;" />
        </div>

        <div class="field">
          <label>Ø±Ù…Ø²/ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ø³Ø±ÙŠ)</label>
          <input type="text" id="e-space-code" style="direction:ltr; text-align:right;" />
        </div>

        <div class="field">
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</label>
          <input type="date" id="e-start" />
        </div>

        <div class="field">
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</label>
          <input type="date" id="e-end" />
        </div>
      </div>

      <div class="mini-row">
        <input type="checkbox" id="e-paid" />
        <span>Ù…Ø¯ÙÙˆØ¹</span>

        <div style="flex:1"></div>

        <input type="checkbox" id="e-reminded" />
        <span>ØªÙ… Ø§Ù„ØªØ°ÙƒÙŠØ±</span>
      </div>

      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeEdit()">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn-save" onclick="saveEdit()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
      </div>
    </div>
  </div>

  <div class="tabs-bar">
    <div class="tabs">
      <button id="tab-all" class="tab-btn active" onclick="setFilter('all')">
        <span class="tab-badge success" id="badge-all">0</span>
        <span class="icon">ğŸ‘¥</span>
        <span class="label">Ø§Ù„ÙƒÙ„</span>
      </button>
      <button id="tab-unpaid" class="tab-btn" onclick="setFilter('unpaid')">
        <span class="tab-badge danger" id="badge-unpaid">0</span>
        <span class="icon">ğŸ’¸</span>
        <span class="label">Ù„Ù… ÙŠØ¯ÙØ¹</span>
      </button>
      <button id="tab-soon" class="tab-btn" onclick="setFilter('soon')">
        <span class="tab-badge warning" id="badge-soon">0</span>
        <span class="icon">â³</span>
        <span class="label">Ù‚Ø±ÙŠØ¨</span>
      </button>
      <button id="tab-expired" class="tab-btn" onclick="setFilter('expired')">
        <span class="tab-badge danger" id="badge-expired">0</span>
        <span class="icon">â›”</span>
        <span class="label">Ù…Ù†ØªÙ‡ÙŠ</span>
      </button>
    </div>
  </div>

  <script>
    let db = JSON.parse(localStorage.getItem('cheap_store_m_db')) || [];
    let currentFilter = 'all';
    let editingId = null;

    function hapticAndClickSound() {
      if (navigator.vibrate) navigator.vibrate(18);
      try {
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (!AudioCtx) return;
        const ctx = new AudioCtx();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.setValueAtTime(880, ctx.currentTime);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.04, ctx.currentTime + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.08);
        o.connect(g);
        g.connect(ctx.destination);
        o.start();
        o.stop(ctx.currentTime + 0.09);
        setTimeout(() => ctx.close().catch(()=>{}), 150);
      } catch (e) {}
    }

    function exportData() {
      if (db.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§");
      const dataStr = JSON.stringify(db, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
      const exportFileDefaultName = 'SubscriptionLady_Backup_' + new Date().toLocaleDateString() + '.json';
      let linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const importedDb = JSON.parse(e.target.result);
          if (Array.isArray(importedDb)) {
            if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©ØŸ")) {
              db = importedDb;
              localStorage.setItem('cheap_store_m_db', JSON.stringify(db));
              render();
              alert("ØªÙ…Øª Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…");
            }
          } else alert("ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­!");
        } catch (err) { alert("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù!"); }
      };
      reader.readAsText(file);
    }

    function setInitialDates() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const today = `${year}-${month}-${day}`;
      document.getElementById('f-start').value = today;
      updateDate();
    }

    function updateDate() {
      let startInput = document.getElementById('f-start').value;
      if (!startInput) return;
      let start = new Date(startInput);
      start.setMonth(start.getMonth() + 1);
      const year = start.getFullYear();
      const month = String(start.getMonth() + 1).padStart(2, '0');
      const day = String(start.getDate()).padStart(2, '0');
      document.getElementById('f-end').value = `${year}-${month}-${day}`;
    }

    setInitialDates();

    function normalizeIraqPhone(phone) {
      phone = (phone || "").replace(/\D/g, '');
      if (phone.startsWith('964')) phone = '0' + phone.substring(3);
      else if (phone && !phone.startsWith('0')) phone = '0' + phone;
      return phone;
    }

    function copyText(text) {
      if (!text) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù†Ø³Ø®");
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => alert("ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…")).catch(() => fallbackCopy(text));
      } else fallbackCopy(text);
    }

    function fallbackCopy(text) {
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.left = '0';
      ta.style.top = '0';
      ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      try { document.execCommand('copy'); alert("ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…"); }
      catch (e) { alert("ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø®ØŒ Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§."); }
      document.body.removeChild(ta);
    }

    function copySpaceEmail(id) { const c = db.find(x => x.id === id); copyText(c?.spaceEmail || ""); }
    function copySpaceCode(id) { const c = db.find(x => x.id === id); copyText(c?.spaceCode || ""); }

    function openChatGPTLogin(id) {
      const c = db.find(x => x.id === id);
      const bundle = `Space Email: ${c?.spaceEmail || ""}\nSpace Code: ${c?.spaceCode || ""}`;
      if ((c?.spaceEmail && c.spaceEmail.trim() !== "") || (c?.spaceCode && c.spaceCode.trim() !== "")) copyText(bundle);
      else alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ÙŠÙ…ÙŠÙ„/Ø±Ù…Ø² Ù„Ù„Ù…Ø³Ø§Ø­Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø²Ø¨ÙˆÙ†. Ø£Ø¶ÙÙ‡Ø§ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø¬Ø±Ù‘Ø¨.");
      alert("Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨ÙˆØ¶Ø¹ Ø§Ù„ØªØµÙØ­ Ø§Ù„Ù…ØªØ®ÙÙŠ (Incognito) Ù…Ù† ÙƒØ±ÙˆÙ…ØŒ Ø«Ù… Ø§Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ.");
      window.open("https://chatgpt.com", "_blank");
    }

    function contact(id) {
      let c = db.find(x => x.id === id);
      if (!c) return;
      let p = (c.phone || "").replace(/\D/g, '');
      if (p.startsWith('0')) p = '964' + p.substring(1);
      window.open(`https://api.whatsapp.com/send?phone=${p}`, '_blank');
    }

    function save() {
      const name = document.getElementById('f-name').value;
      let phone = document.getElementById('f-phone').value;
      const space = document.getElementById('f-space').value || 'Ø¹Ø§Ù…';
      const email = document.getElementById('f-email').value || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
      const price = document.getElementById('f-price').value;
      const endDate = document.getElementById('f-end').value;
      const spaceEmail = document.getElementById('f-space-email').value || '';
      const spaceCode = document.getElementById('f-space-code').value || '';
      if (!name || !phone || !endDate) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©");
      phone = normalizeIraqPhone(phone);

      const item = {
        id: crypto.randomUUID(),
        name, phone, email, space, spaceEmail, spaceCode,
        service: document.getElementById('f-service').value,
        price: price,
        start: document.getElementById('f-start').value,
        end: endDate,
        paid: false,
        paymentDate: "",
        reminded: false,
        createdAt: new Date().toISOString()
      };

      db.unshift(item);
      localStorage.setItem('cheap_store_m_db', JSON.stringify(db));

      document.getElementById('f-name').value = '';
      document.getElementById('f-phone').value = '';
      document.getElementById('f-email').value = '';
      document.getElementById('f-space').value = '';
      document.getElementById('f-space-email').value = '';
      document.getElementById('f-space-code').value = '';

      setInitialDates();
      render();
      window.scrollTo(0, 0);
    }

    function openEdit(id) {
      const i = db.findIndex(x => x.id === id);
      if (i === -1) return;
      const c = db[i];
      editingId = id;

      document.getElementById('e-service').value = c.service || "ChatGPT Plus";
      document.getElementById('e-price').value = parseInt(c.price) || 0;
      document.getElementById('e-space').value = c.space || 'Ø¹Ø§Ù…';
      document.getElementById('e-name').value = c.name || '';
      document.getElementById('e-phone').value = c.phone || '';
      document.getElementById('e-email').value = (c.email && c.email !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') ? c.email : '';
      document.getElementById('e-space-email').value = c.spaceEmail || '';
      document.getElementById('e-space-code').value = c.spaceCode || '';
      document.getElementById('e-start').value = c.start || '';
      document.getElementById('e-end').value = c.end || '';
      document.getElementById('e-paid').checked = !!c.paid;
      document.getElementById('e-reminded').checked = !!c.reminded;

      document.getElementById('edit-overlay').style.display = 'flex';
      setTimeout(() => document.getElementById('e-name').focus(), 10);
    }

    function closeEdit() { editingId = null; document.getElementById('edit-overlay').style.display = 'none'; }
    function closeEditIfOutside(e) { if (e.target && e.target.id === 'edit-overlay') closeEdit(); }

    function saveEdit() {
      if (!editingId) return;
      const i = db.findIndex(x => x.id === editingId);
      if (i === -1) return;

      const name = document.getElementById('e-name').value.trim();
      let phone = document.getElementById('e-phone').value.trim();
      const space = document.getElementById('e-space').value.trim() || 'Ø¹Ø§Ù…';
      const email = document.getElementById('e-email').value.trim() || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
      const spaceEmail = document.getElementById('e-space-email').value.trim();
      const spaceCode = document.getElementById('e-space-code').value.trim();
      const service = document.getElementById('e-service').value;
      const priceNum = parseInt(document.getElementById('e-price').value);
      const start = document.getElementById('e-start').value;
      const end = document.getElementById('e-end').value;
      const paid = document.getElementById('e-paid').checked;
      const reminded = document.getElementById('e-reminded').checked;

      if (!name || !phone || !end) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† + Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ + ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©");
      phone = normalizeIraqPhone(phone);

      db[i].name = name;
      db[i].phone = phone;
      db[i].space = space;
      db[i].email = email;
      db[i].spaceEmail = spaceEmail;
      db[i].spaceCode = spaceCode;
      db[i].service = service;
      db[i].price = isNaN(priceNum) ? (db[i].price || "0") : String(priceNum);
      db[i].start = start || db[i].start;
      db[i].end = end;
      db[i].reminded = reminded;

      const wasPaid = !!db[i].paid;
      db[i].paid = paid;
      if (paid && !wasPaid) db[i].paymentDate = new Date().toISOString();
      else if (!paid) db[i].paymentDate = "";

      localStorage.setItem('cheap_store_m_db', JSON.stringify(db));
      closeEdit();
      render();
      alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…");
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const overlay = document.getElementById('edit-overlay');
        if (overlay && overlay.style.display === 'flex') closeEdit();
      }
    });

    function sendSoonReminder(id, daysLeft) {
      let i = db.findIndex(x => x.id === id);
      if (i === -1) return;
      let c = db[i];

      let p = c.phone.replace(/\D/g, '');
      if (p.startsWith('0')) p = '964' + p.substring(1);

      const msg = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… \n` +
        `Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ø²Ø¨ÙˆÙ† Ø¨Ø§Ù‚ÙŠ ${daysLeft} ÙŠÙˆÙ…/Ø£ÙŠØ§Ù… Ø¹Ù„Ù‰ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙÙŠ (${c.service}) Ø¨ØªØ§Ø±ÙŠØ® (${c.end}). \n` +
        `Ø¥Ø°Ø§ ØªØ­Ø¨ ØªØ¬Ø¯Ø¯ Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ø±Ø§Ø³Ù„Ù†Ø§ ÙˆØ§Ø­Ù†Ø§ Ø¨Ø§Ù„Ø®Ø¯Ù…Ø©. \n` +
        `ÙˆØ´ÙƒØ±Ø§Ù‹ Ø¬Ø²ÙŠÙ„Ø§Ù‹ Ø§Ù„Ùƒ`;

      db[i].reminded = true;
      localStorage.setItem('cheap_store_m_db', JSON.stringify(db));
      render();

      window.open(`https://api.whatsapp.com/send?phone=${p}&text=${encodeURIComponent(msg)}`, '_blank');
    }

    function renewSubscription(id) {
      let i = db.findIndex(x => x.id === id);
      if (i === -1) return;

      const currentSpace = db[i].space || 'Ø¹Ø§Ù…';
      const currentSpaceEmail = db[i].spaceEmail || '';
      const currentSpaceCode = db[i].spaceCode || '';

      let newSpaceName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø­Ø© (ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡):", currentSpace);
      if (newSpaceName === null) return;

      let newSpaceEmail = prompt("Ø£Ø¯Ø®Ù„ Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø³Ø±ÙŠ (ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡):", currentSpaceEmail);
      if (newSpaceEmail === null) return;

      let newSpaceCode = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±/Ø§Ù„Ø±Ù…Ø² Ù„Ù„Ù…Ø³Ø§Ø­Ø© (ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡):", currentSpaceCode);
      if (newSpaceCode === null) return;

      if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù…Ø¯Ø© Ø´Ù‡Ø± Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…ØŸ")) return;

      if (newSpaceName.trim() !== "") db[i].space = newSpaceName.trim();
      db[i].spaceEmail = (newSpaceEmail || '').trim();
      db[i].spaceCode = (newSpaceCode || '').trim();

      let newStartDate = new Date();
      newStartDate.setHours(0,0,0,0);
      let newEndDate = new Date(newStartDate);
      newEndDate.setMonth(newEndDate.getMonth() + 1);

      const formatDate = (date) => {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      };

      db[i].start = formatDate(newStartDate);
      db[i].end = formatDate(newEndDate);
      db[i].paid = true;
      db[i].paymentDate = new Date().toISOString();
      db[i].reminded = false;

      localStorage.setItem('cheap_store_m_db', JSON.stringify(db));
      render();
      alert("ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
    }

    function togglePay(id) {
      let i = db.findIndex(x => x.id === id);
      if (i === -1) return;
      db[i].paid = !db[i].paid;
      db[i].paymentDate = db[i].paid ? new Date().toISOString() : "";
      localStorage.setItem('cheap_store_m_db', JSON.stringify(db));
      render();
    }

    function del(id) {
      if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´ØªØ±ÙƒØŸ")) {
        db = db.filter(x => x.id !== id);
        localStorage.setItem('cheap_store_m_db', JSON.stringify(db));
        render();
      }
    }

    function wa(id) {
      let c = db.find(x => x.id === id);
      if (!c) return;
      let p = c.phone.replace(/\D/g, '');
      if (p.startsWith('0')) p = '964' + p.substring(1);

      let msg = `*Subscription Lady*\n\n` +
        `ğŸ‘¤ Ø§Ù„Ø²Ø¨ÙˆÙ†: ${c.name}\n` +
        `ğŸš€ Ø§Ù„Ù…Ø³Ø§Ø­Ø©: ${c.space || 'Ø¹Ø§Ù…'}\n` +
        `ğŸ›  Ø§Ù„Ø®Ø¯Ù…Ø©: ${c.service}\n` +
        `ğŸ“§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„: ${c.email}\n` +
        `ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: ${parseInt(c.price).toLocaleString()} Ø¯.Ø¹\n` +
        `ğŸ“… ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ: ${c.end}\n` +
        `ğŸ’³ Ø§Ù„Ø­Ø§Ù„Ø©: ${c.paid ? 'ØªÙ… Ø§Ù„Ø¯ÙØ¹ âœ…' : 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹ âŒ'}`;

      window.open(`https://api.whatsapp.com/send?phone=${p}&text=${encodeURIComponent(msg)}`, '_blank');
    }

    function snap(id) {
      let c = db.find(x => x.id === id);
      if (!c) return;

      document.getElementById('r-date').innerText = "ØªØ­Ø±ÙŠØ±Ø§Ù‹ ÙÙŠ: " + new Date().toLocaleDateString('ar-EG');

      document.getElementById('receipt-data').innerHTML = `
        <div class="receipt-row"><span>ğŸ‘¤ Ø§Ù„Ø²Ø¨ÙˆÙ†:</span> <b>${c.name}</b></div>
        <div class="receipt-row"><span>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ:</span> <b style="direction:ltr;">${c.phone}</b></div>
        <div class="receipt-row"><span>ğŸ›  Ø§Ù„Ø®Ø¯Ù…Ø©:</span> <b>${c.service}</b></div>
        <div class="receipt-row"><span>ğŸš€ Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</span> <b>${c.space || 'Ø¹Ø§Ù…'}</b></div>
        <div class="receipt-row"><span>ğŸ“§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:</span> <b style="direction:ltr;">${c.email}</b></div>
        <div class="receipt-row"><span>ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº:</span> <b style="color:#fbbf24;">${parseInt(c.price).toLocaleString()} Ø¯.Ø¹</b></div>
        <div class="receipt-row"><span>ğŸ“… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</span> <b style="color:#f87171;">${c.end}</b></div>
        <div class="receipt-row"><span>ğŸ’³ Ø§Ù„Ø­Ø§Ù„Ø©:</span> <b style="color:${c.paid ? '#10b981' : '#ef4444'};">${c.paid ? 'ØªÙ… Ø§Ù„Ø¯ÙØ¹ âœ…' : 'Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø¯ÙØ¹ â³'}</b></div>
      `;

      const target = document.getElementById('receipt-box');

      requestAnimationFrame(() => {
        html2canvas(target, {
          backgroundColor: '#0b1220',
          scale: 3,
          useCORS: true,
          allowTaint: true
        }).then(canvas => {
          const safeName = (c.name || 'Ø²Ø¨ÙˆÙ†').replace(/[\\/:*?"<>|]/g, '-');
          const filename = `ÙˆØµÙ„-${safeName}.png`;

          canvas.toBlob((blob) => {
            if (!blob) {
              let a = document.createElement('a');
              a.download = filename;
              a.href = canvas.toDataURL("image/png");
              a.click();
              return;
            }
            const url = URL.createObjectURL(blob);
            let a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            setTimeout(() => URL.revokeObjectURL(url), 1500);
          }, "image/png");
        }).catch(() => alert("ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© Ø§Ù„ÙˆØµÙ„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."));
      });
    }

    function buildCard(c, flags) {
      const { isExpired, isSoon, daysLeft } = flags;

      let renewBtnHtml = '';
      if (isSoon || isExpired) {
        renewBtnHtml = `<div class="action-btn bg-renew" style="grid-column: span 4; margin-bottom: 8px;" onclick="renewSubscription('${c.id}')">ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù…Ø¯Ø© Ø´Ù‡Ø± ğŸ”„</div>`;
      }

      let reminderBtnHtml = '';
      if (isSoon) {
        if (c.reminded) {
          reminderBtnHtml = `<div class="action-btn bg-reminded" style="grid-column: span 4; margin-bottom: 8px;">ØªÙ… Ø§Ù„ØªØ°ÙƒÙŠØ± âœ…</div>`;
        } else {
          reminderBtnHtml = `<div class="action-btn bg-warning" style="grid-column: span 4; margin-bottom: 8px;" onclick="sendSoonReminder('${c.id}', ${daysLeft})">Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ± (ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ ${daysLeft} ÙŠÙˆÙ…) ğŸ’¬</div>`;
        }
      }

      let spaceSecretHtml = '';
      const hasSpaceSecrets = (c.spaceEmail && c.spaceEmail.trim() !== "") || (c.spaceCode && c.spaceCode.trim() !== "");
      if (hasSpaceSecrets) {
        spaceSecretHtml = `
          <div class="action-btn" style="grid-column: span 4; background:#0b1220; border:1px solid #243155; color:#cbd5e1; cursor: default;">
            ğŸ” Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ø³Ø±ÙŠÙ‘Ø©):
            <span style="direction:ltr; unicode-bidi:plaintext; font-weight:700; color:#fff;">
              ${c.spaceEmail ? c.spaceEmail : 'â€”'}${c.spaceCode ? ' / ' + c.spaceCode : ''}
            </span>
          </div>
          <div class="action-btn" style="background:#0ea5e9;" onclick="copySpaceEmail('${c.id}')">Ù†Ø³Ø® Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</div>
          <div class="action-btn" style="background:#8b5cf6;" onclick="copySpaceCode('${c.id}')">Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²</div>
          <div class="action-btn" style="background:#22c55e;" onclick="openChatGPTLogin('${c.id}')">Ø¯Ø®ÙˆÙ„ ChatGPT</div>
          <div class="action-btn" style="background:#334155; cursor: default;">Ø³Ø±ÙŠ</div>
        `;
      } else {
        spaceSecretHtml = `
          <div class="action-btn" style="grid-column: span 4; background:#0b1220; border:1px dashed #243155; color:#a7b0c6; cursor: default;">
            ğŸ” Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ø³Ø±ÙŠÙ‘Ø©): ØºÙŠØ± Ù…Ø¶Ø§ÙØ©
          </div>
          <div class="action-btn" style="background:#0ea5e9;" onclick="copySpaceEmail('${c.id}')">Ù†Ø³Ø® Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</div>
          <div class="action-btn" style="background:#8b5cf6;" onclick="copySpaceCode('${c.id}')">Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²</div>
          <div class="action-btn" style="background:#22c55e;" onclick="openChatGPTLogin('${c.id}')">Ø¯Ø®ÙˆÙ„ ChatGPT</div>
          <div class="action-btn" style="background:#334155; cursor: default;">Ø³Ø±ÙŠ</div>
        `;
      }

      const currentPrice = parseInt(c.price) || 0;
      const card = document.createElement('div');
      card.className = `customer-card ${isExpired ? 'expired' : ''} ${isSoon ? 'warning-near' : ''} ${(c.service || "").includes('â­') ? 'special' : ''}`;

      let topBanner = '';
      if (isSoon) topBanner = `<div class="reminder-banner">ğŸ”” ØªÙ†Ø¨ÙŠÙ‡: ÙŠÙ†ØªÙ‡ÙŠ Ø§Ø´ØªØ±Ø§Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø²Ø¨ÙˆÙ† Ø®Ù„Ø§Ù„ ${daysLeft} ÙŠÙˆÙ…/Ø£ÙŠØ§Ù…!</div>`;
      if (isExpired) topBanner = `<div class="expired-banner">â›” ØªÙ†Ø¨ÙŠÙ‡: Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù†ØªÙ‡ÙŠ</div>`;

      card.innerHTML = `
        ${topBanner}
        <div class="card-top">
          <div class="cust-name">${c.name}</div>
          <div class="cust-service">${c.service}</div>
        </div>
        <div class="card-info">
          <div>ğŸš€ Ø§Ù„Ù…Ø³Ø§Ø­Ø©: <b>${c.space || 'Ø¹Ø§Ù…'}</b></div>
          <div>ğŸ“§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„: <span class="email-text">${c.email}</span></div>
          <div>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: <b>${c.phone}</b></div>
          <div>ğŸ“… ÙŠÙ†ØªÙ‡ÙŠ: <b style="color:${isExpired ? 'var(--danger)' : (isSoon ? 'var(--warning)' : 'inherit')}">${c.end}</b>
            ${isSoon ? '<span class="status-tag status-warning">Ù‚Ø±ÙŠØ¨ ğŸ””</span>' : ''}
            ${isExpired ? '<span class="status-tag status-unpaid">Ù…Ù†ØªÙ‡ÙŠ â›”</span>' : ''}
          </div>
          <div>ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: ${currentPrice.toLocaleString()} Ø¯.Ø¹
            <span class="status-tag ${c.paid ? 'status-paid' : 'status-unpaid'}">${c.paid ? 'Ù…Ø¯ÙÙˆØ¹' : 'Ù„Ù… ÙŠØ¯ÙØ¹'}</span>
          </div>
        </div>
        <div class="card-actions">
          ${renewBtnHtml}
          ${reminderBtnHtml}
          ${spaceSecretHtml}

          <div class="action-btn bg-edit" onclick="openEdit('${c.id}')">ØªØ¹Ø¯ÙŠÙ„ âœï¸</div>
          <div class="action-btn bg-pay" onclick="togglePay('${c.id}')">${c.paid ? 'Ø¥Ù„ØºØ§Ø¡ Ø¯ÙØ¹' : 'ØªØ£ÙƒÙŠØ¯ Ø¯ÙØ¹'}</div>
          <div class="action-btn bg-contact" onclick="contact('${c.id}')">ØªÙˆØ§ØµÙ„</div>
          <div class="action-btn bg-whatsapp" onclick="wa('${c.id}')">ÙˆØ§ØªØ³</div>

          <div class="action-btn bg-img" onclick="snap('${c.id}')">ÙˆØµÙ„</div>
          <div class="action-btn bg-del" onclick="del('${c.id}')">Ø­Ø°Ù</div>
        </div>
      `;
      return card;
    }

    function computeFlags(c, todayStart) {
      const endDate = new Date(c.end);
      endDate.setHours(0,0,0,0);
      const msDay = 24 * 60 * 60 * 1000;
      const diffDays = Math.round((endDate.getTime() - todayStart.getTime()) / msDay);
      const isExpired = diffDays < 0;
      const isSoon = diffDays >= 0 && diffDays <= 3;
      return { isExpired, isSoon, daysLeft: diffDays };
    }

    function setFilter(filter) {
      hapticAndClickSound();
      currentFilter = filter;
      ['all','unpaid','soon','expired'].forEach(t => {
        const el = document.getElementById('tab-' + t);
        if (el) el.classList.toggle('active', t === filter);
      });
      render();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function render() {
      const q = (document.getElementById('q').value || "").toLowerCase();
      const list = document.getElementById('list');
      list.innerHTML = '';

      let totalMoney = 0, todayMoney = 0, totalDebt = 0;
      let expiredCount = 0, soonCount = 0, unpaidCount = 0;

      const now = new Date();
      const todayStr = now.toISOString().split('T')[0];
      const todayStart = new Date(); todayStart.setHours(0,0,0,0);

      db.forEach(c => {
        const price = parseInt(c.price) || 0;
        if (c.paid) {
          totalMoney += price;
          if (c.paymentDate && c.paymentDate.split('T')[0] === todayStr) todayMoney += price;
        } else {
          totalDebt += price; unpaidCount++;
        }
        const flags = computeFlags(c, todayStart);
        if (flags.isExpired) expiredCount++;
        if (flags.isSoon) soonCount++;
      });

      document.getElementById('badge-all').innerText = db.length;
      document.getElementById('badge-unpaid').innerText = unpaidCount;
      document.getElementById('badge-soon').innerText = soonCount;
      document.getElementById('badge-expired').innerText = expiredCount;

      document.getElementById('stat-count').innerText = db.length;
      document.getElementById('stat-money').innerText = totalMoney.toLocaleString() + " Ø¯.Ø¹";
      document.getElementById('stat-today-money').innerText = todayMoney.toLocaleString() + " Ø¯.Ø¹";
      document.getElementById('stat-debt').innerText = totalDebt.toLocaleString() + " Ø¯.Ø¹";
      document.getElementById('stat-expired').innerText = expiredCount;
      document.getElementById('stat-need-reminder').innerText = soonCount;

      const titleMap = {
        all: "ÙƒÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†",
        unpaid: "Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù„Ù… ÙŠØ¯ÙØ¹ÙˆØ§",
        soon: "Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø§Ù„Ø°ÙŠÙ† ÙŠÙ†ØªÙ‡ÙŠ Ø§Ø´ØªØ±Ø§ÙƒÙ‡Ù… Ù‚Ø±ÙŠØ¨Ø§Ù‹",
        expired: "Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ø§Ù†ØªÙ‡Ù‰ Ø§Ø´ØªØ±Ø§ÙƒÙ‡Ù…"
      };
      document.getElementById('filter-title').innerText = titleMap[currentFilter] || "ÙƒÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†";

      let shown = 0;
      db.forEach(c => {
        const flags = computeFlags(c, todayStart);
        const match =
          (c.name || "").toLowerCase().includes(q) ||
          (c.email || "").toLowerCase().includes(q) ||
          (c.space || "").toLowerCase().includes(q) ||
          (c.service || "").toLowerCase().includes(q);
        if (!match) return;

        let pass = true;
        if (currentFilter === 'unpaid') pass = !c.paid;
        else if (currentFilter === 'soon') pass = flags.isSoon;
        else if (currentFilter === 'expired') pass = flags.isExpired;
        if (!pass) return;

        list.appendChild(buildCard(c, flags));
        shown++;
      });

      document.getElementById('filter-subtitle').innerText = `${shown} Ù†ØªÙŠØ¬Ø©`;
      if (shown === 0) {
        const div = document.createElement('div');
        div.className = 'empty';
        div.innerText = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…";
        list.appendChild(div);
      }
    }

    render();
  </script>
</body>
</html>