<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Subscription Lady</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Firebase (Google) - compat version for simple usage in one HTML -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --primary: #ec4899;
      --secondary: #f472b6;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;

      --bg: #0b0612;
      --card: #140a1f;
      --text: #ffffff;
      --input-bg: #1f0f2e;
    }

    * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; }
    body{
      background-color: var(--bg);
      color: var(--text);
      margin:0;
      padding:0;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    .app-header{
      background: linear-gradient(135deg, #ec4899, #db2777);
      color:#fff;
      padding: 22px 16px;
      text-align:center;
      position: sticky;
      top:0;
      z-index:100;
      border-bottom: 1px solid rgba(255,255,255,0.14);
      box-shadow: 0 8px 20px rgba(0,0,0,0.35);
    }
    .app-header h1{ margin:0; font-size:1.85rem; font-weight:900; }
    .app-header p{ margin:6px 0 0; font-size:1rem; font-weight:800; opacity:0.95; }

    .container{ padding:15px; flex:1; padding-bottom: 90px; }

    .backup-controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom:12px;
    }
    .btn-backup{
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(236,72,153,0.22);
      background: var(--card);
      color:#fff;
      font-size:0.95rem;
      font-weight:900;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn-export{ border-color: rgba(16,185,129,0.55); color:#6ee7b7; }
    .btn-import{ border-color: rgba(236,72,153,0.55); color:#f9a8d4; }

    .cloud-controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom: 18px;
    }
    .btn-cloud{
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(236,72,153,0.22);
      background: #0f0a17;
      color:#fff;
      font-size:0.95rem;
      font-weight:900;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn-login{ border-color: rgba(59,130,246,0.55); color:#93c5fd; }
    .btn-logout{ border-color: rgba(239,68,68,0.55); color:#fca5a5; }

    .cloud-status{
      background: rgba(20,10,31,0.75);
      border: 1px solid rgba(236,72,153,0.18);
      border-radius: 14px;
      padding: 10px 12px;
      margin-bottom: 16px;
      color: rgba(255,255,255,0.9);
      font-weight: 900;
      display:flex;
      justify-content: space-between;
      gap: 10px;
      align-items:center;
    }
    .cloud-status small{ opacity:0.9; font-weight:800; }
    .pill{
      border: 1px solid rgba(236,72,153,0.22);
      background: rgba(0,0,0,0.25);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.85rem;
      font-weight: 900;
      white-space: nowrap;
    }

    .stats-bar{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom:16px;
    }
    .stat-item{
      background: var(--card);
      padding:15px 6px;
      border-radius:12px;
      text-align:center;
      border:1px solid rgba(236,72,153,0.18);
    }
    .stat-item b{ display:block; font-size:1.2rem; color:#fff; margin-bottom:4px; font-weight:900; }
    .stat-item span{ font-size:0.92rem; color: rgba(255,255,255,0.80); font-weight:800; }

    .form-card{
      background: var(--card);
      padding:20px;
      border-radius:15px;
      margin-bottom:18px;
      box-shadow: 0 10px 18px rgba(0,0,0,0.45);
      border:1px solid rgba(236,72,153,0.18);
    }
    .form-card h2{
      font-size:1.2rem;
      margin:0 0 15px;
      color:#f9a8d4;
      border-bottom: 1px solid rgba(236,72,153,0.18);
      padding-bottom: 10px;
      font-weight:900;
    }

    .field{ margin-bottom:15px; }
    label{ display:block; font-size:0.98rem; font-weight:900; margin-bottom:7px; color: rgba(255,255,255,0.92); }
    input, select{
      width:100%;
      padding:14px;
      border:1px solid rgba(236,72,153,0.22);
      border-radius:12px;
      font-size:1.05rem;
      background: var(--input-bg);
      color:#fff;
      transition:0.25s;
    }
    input:focus, select:focus{ border-color: rgba(236,72,153,0.70); outline:none; background:#24113a; }

    .btn-main{
      width:100%;
      padding:16px;
      background: linear-gradient(135deg, #ec4899, #f472b6);
      color:#140a1f;
      border:none;
      border-radius:12px;
      font-weight:900;
      font-size:1.15rem;
      margin-top:10px;
      cursor:pointer;
      box-shadow: 0 6px 14px rgba(236,72,153,0.25);
    }

    .filter-title{
      background: rgba(20,10,31,0.75);
      border: 1px solid rgba(236,72,153,0.18);
      border-radius: 16px;
      padding: 12px 14px;
      margin-bottom: 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .filter-title b { color:#fff; font-weight:900; font-size:1.05rem; }
    .filter-title span { color: rgba(255,255,255,0.80); font-weight:900; font-size:0.95rem; }

    .customer-card{
      background: var(--card);
      border-radius:15px;
      padding:18px;
      margin-bottom:15px;
      position:relative;
      border-right: 6px solid var(--primary);
      border: 1px solid rgba(236,72,153,0.18);
    }
    .customer-card.special { border-right-color: var(--warning); background: #170b25; }
    .customer-card.expired { border-right-color: var(--danger); opacity: 0.97; }
    .customer-card.warning-near { border-right-color: var(--warning); border-right-width: 9px; }

    .card-top{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; gap:10px; }
    .cust-name{ font-weight:900; font-size:1.15rem; color:#fff; }
    .cust-service{ font-size:0.9rem; color:#140a1f; background: var(--primary); padding:5px 10px; border-radius:8px; font-weight:900; }

    .card-info{ font-size:1.02rem; margin-bottom:15px; line-height:1.75; color: rgba(255,255,255,0.88); }
    .card-info b{ color:#fff; }
    .email-text{ font-size:0.92rem; color: rgba(255,255,255,0.92); font-weight:800; word-break: break-all; }

    .card-actions{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      border-top: 1px solid rgba(236,72,153,0.18);
      padding-top: 15px;
    }
    .action-btn{
      border:none;
      padding:12px 0;
      border-radius:10px;
      color:#fff;
      font-size:0.92rem;
      font-weight:900;
      text-align:center;
      cursor:pointer;
      user-select:none;
    }

    .bg-whatsapp{ background:#16a34a; }
    .bg-contact{ background:#22c55e; }
    .bg-pay{ background: var(--success); }
    .bg-img{ background:#f472b6; }
    .bg-del{ background: var(--danger); }
    .bg-edit{ background:#db2777; }
    .bg-warning{ background: var(--warning); color:#000; }
    .bg-reminded{ background:#10b981; color:#fff; }
    .bg-renew{ background:#ec4899; color:#fff; }

    .status-tag{
      font-size:0.82rem;
      padding:3px 8px;
      border-radius:6px;
      margin-right:5px;
      font-weight:900;
    }
    .status-paid{ background:#064e3b; color:#34d399; }
    .status-unpaid{ background:#7f1d1d; color:#f87171; }
    .status-warning{ background:#78350f; color:#fbbf24; }

    .reminder-banner{
      background: var(--warning);
      color:#000;
      text-align:center;
      font-weight:900;
      font-size:0.95rem;
      padding:7px;
      border-radius:8px;
      margin-bottom:12px;
      animation:pulse 2s infinite;
    }
    .expired-banner{
      background: var(--danger);
      color:#fff;
      text-align:center;
      font-weight:900;
      font-size:0.95rem;
      padding:7px;
      border-radius:8px;
      margin-bottom:12px;
      opacity:0.97;
    }
    @keyframes pulse{
      0%{ opacity:1; }
      50%{ opacity:0.75; }
      100%{ opacity:1; }
    }

    #hidden-area{
      position:fixed;
      left:0;
      top:0;
      opacity:0;
      pointer-events:none;
    }

    /* âœ… Ø§Ù„ÙˆØµÙ„: ÙˆØ±Ø¯ÙŠ ÙØ§ØªØ­ Ø¬Ø¯Ù‹Ø§ + ÙƒØªØ§Ø¨Ø© Ø¯Ø§ÙƒÙ†Ø© Ø­ØªÙ‰ ØªÙƒÙˆÙ† ÙˆØ§Ø¶Ø­Ø© */
    .receipt{
      width:650px;
      background: linear-gradient(135deg, #ffe4f1 0%, #ffd1e8 60%, #ffc1e2 100%);
      color:#111827; /* âœ… Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¯Ø§ÙƒÙ†Ø© Ù„Ù„ÙˆØ¶ÙˆØ­ */
      padding:45px;
      text-align:right;
      border: 6px solid rgba(236,72,153,0.25);
      border-radius: 30px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.35);
    }
    .receipt h2{
      color:#111827;
      text-align:center;
      margin-bottom: 26px;
      font-size: 2.7rem;
      font-weight: 900;
      border-bottom: 4px solid rgba(17,24,39,0.12);
      padding-bottom: 16px;
    }
    .receipt-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
      border-bottom: 1px solid rgba(17,24,39,0.10);
      padding-bottom:10px;
      gap:18px;
    }
    .receipt-row span{
      color: rgba(17,24,39,0.70);
      font-weight: 900;
      font-size: 1.35rem;
      min-width: 170px;
    }
    .receipt-row b{
      color:#111827;
      font-size: 1.35rem;
      font-weight: 900;
    }
    .receipt-footer{
      text-align:center;
      margin-top: 34px;
      padding: 22px;
      background: rgba(255,255,255,0.55);
      border-radius: 20px;
      border: 2px solid rgba(17,24,39,0.08);
    }
    .contact-info{
      color:#111827;
      font-size: 2.6rem;
      font-weight: 900;
      margin: 10px 0;
      display:block;
      direction:ltr;
    }
    .thank-you-msg{
      font-size: 1.7rem;
      color:#111827;
      margin-bottom: 8px;
      font-weight: 900;
    }
    .receipt-date{
      font-size: 1.1rem;
      color: rgba(17,24,39,0.75);
      font-weight: 900;
    }

    .modal-overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.60);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
      padding:14px;
    }
    .modal{
      width:min(720px, 100%);
      max-height:88vh;
      overflow:auto;
      background: var(--card);
      border:1px solid rgba(236,72,153,0.22);
      border-radius:18px;
      box-shadow:0 20px 40px rgba(0,0,0,0.55);
      padding:16px;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
      padding-bottom:10px;
      border-bottom:1px solid rgba(236,72,153,0.18);
    }
    .modal-title{
      font-weight:900;
      color:#fff;
      font-size:1.08rem;
    }
    .modal-close{
      background:transparent;
      border:1px solid rgba(236,72,153,0.22);
      color: rgba(255,255,255,0.92);
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
    }
    .modal-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width:560px){
      .modal-grid{ grid-template-columns:1fr; }
    }
    .modal-actions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:14px;
      padding-top:12px;
      border-top:1px solid rgba(236,72,153,0.18);
    }
    .btn-secondary{
      width:100%;
      padding:14px;
      border-radius:12px;
      border:1px solid rgba(236,72,153,0.18);
      background:#0b0612;
      color: rgba(255,255,255,0.92);
      font-weight:900;
      cursor:pointer;
    }
    .btn-save{
      width:100%;
      padding:14px;
      border-radius:12px;
      border:0;
      background: var(--primary);
      color:#0b0612;
      font-weight:900;
      cursor:pointer;
    }
    .mini-row{
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px;
      border:1px solid rgba(236,72,153,0.18);
      border-radius:12px;
      background:#0b0612;
      margin-top:10px;
    }
    .mini-row input[type="checkbox"]{
      width:18px;
      height:18px;
      accent-color:#ec4899;
    }
    .mini-row span{
      color: rgba(255,255,255,0.92);
      font-weight:900;
      font-size:0.95rem;
    }

    .tabs-bar{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      background: rgba(11,6,18,0.92);
      backdrop-filter: blur(8px);
      border-top:1px solid rgba(236,72,153,0.18);
      z-index:999;
      padding:10px 10px 12px;
    }
    .tabs{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      max-width:900px;
      margin:0 auto;
    }
    .tab-btn{
      position:relative;
      border:1px solid rgba(236,72,153,0.18);
      background:#140a1f;
      border-radius:14px;
      color: rgba(255,255,255,0.90);
      padding:10px 8px;
      cursor:pointer;
      text-align:center;
      font-weight:900;
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .tab-btn .icon{ font-size:1.25rem; line-height:1; }
    .tab-btn .label{ font-size:0.9rem; }
    .tab-btn.active{
      border-color: rgba(236,72,153,0.75);
      box-shadow: 0 0 0 3px rgba(236,72,153,0.18);
      color:#fff;
    }
    .tab-badge{
      position:absolute;
      top:-7px;
      left:10px;
      background:#0b0612;
      border:1px solid rgba(236,72,153,0.18);
      color: rgba(255,255,255,0.92);
      border-radius:999px;
      font-size:0.82rem;
      font-weight:900;
      padding:2px 8px;
      min-width:24px;
      text-align:center;
    }
    .tab-badge.danger{ border-color: rgba(239,68,68,0.55); color:#fca5a5; }
    .tab-badge.warning{ border-color: rgba(245,158,11,0.55); color:#fcd34d; }
    .tab-badge.success{ border-color: rgba(16,185,129,0.55); color:#6ee7b7; }

    .empty{
      background: rgba(20,10,31,0.65);
      border:1px dashed rgba(236,72,153,0.25);
      border-radius:16px;
      padding:14px;
      color: rgba(255,255,255,0.78);
      font-weight:900;
      text-align:center;
      margin-top:10px;
      font-size:1rem;
    }
  </style>
</head>

<body>
  <header class="app-header">
    <h1>Subscription Lady ğŸ’–</h1>
    <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ø²Ø¨Ø§Ø¦Ù† Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</p>
  </header>

  <div class="container">

    <div class="cloud-controls">
      <button class="btn-cloud btn-login" onclick="signInWithGoogle()">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Google</button>
      <button class="btn-cloud btn-logout" onclick="signOutGoogle()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="cloud-status">
      <div>
        <div id="cloud-user">ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„</div>
        <small id="cloud-hint">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹. Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Google Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ.</small>
      </div>
      <div class="pill" id="cloud-pill">LOCAL</div>
    </div>

    <div class="backup-controls">
      <button class="btn-backup btn-export" onclick="exportData()">ğŸ“¥ Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
      <button class="btn-backup btn-import" onclick="document.getElementById('file-input').click()">ğŸ“¤ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø©</button>
      <input type="file" id="file-input" style="display:none" accept=".json" onchange="importData(event)" />
    </div>

    <div class="stats-bar">
      <div class="stat-item">
        <b id="stat-count">0</b>
        <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</span>
      </div>
      <div class="stat-item">
        <b id="stat-today-money" style="color:var(--primary)">0</b>
        <span>Ø¯Ø®Ù„ Ø§Ù„ÙŠÙˆÙ…</span>
      </div>

      <div class="stat-item">
        <b id="stat-yesterday-money" style="color:var(--primary)">0</b>
        <span>Ø¯Ø®Ù„ Ø§Ù„Ø£Ù…Ø³</span>
      </div>

      <div class="stat-item">
        <b id="stat-week-money" style="color:var(--primary)">0</b>
        <span>Ø±Ø¨Ø­ Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</span>
      </div>

      <div class="stat-item">
        <b id="stat-month-money" style="color:var(--primary)">0</b>
        <span>Ø±Ø¨Ø­ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</span>
      </div>

      <div class="stat-item">
        <b id="stat-money" style="color:var(--success)">0</b>
        <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ø§Ø®ÙŠÙ„</span>
      </div>

      <div class="stat-item" style="border-color: var(--danger);">
        <b id="stat-debt" style="color:var(--danger)">0</b>
        <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ† (Ù†Ø·Ù„Ø¨Ù‡Ù…)</span>
      </div>

      <div class="stat-item">
        <b id="stat-expired">0</b>
        <span>Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù…Ù†ØªÙ‡ÙŠØ©</span>
      </div>

      <div class="stat-item" style="border-color: var(--warning);">
        <b id="stat-need-reminder" style="color:var(--warning)">0</b>
        <span>ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ 3 Ø£ÙŠØ§Ù…</span>
      </div>
    </div>

    <div class="form-card">
      <h2>â• Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ Ø¬Ø¯ÙŠØ¯</h2>

      <div class="field">
        <label>Ø§Ù„Ø®Ø¯Ù…Ø©</label>
        <select id="f-service">
          <option value="ChatGPT Plus">ChatGPT Plus ğŸ¤–</option>
          <option value="Canva Pro">Canva Pro ğŸ¨</option>
          <option value="CapCut Pro">CapCut Pro ğŸ¬</option>
          <option value="Ø¹Ø¶ÙˆÙŠØ© â­">Ø¹Ø¶ÙˆÙŠØ© Ù…Ù…ÙŠØ²Ø© â­</option>
        </select>
      </div>

      <div class="field">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Space Name)</label>
        <input type="text" id="f-space" placeholder="Ù…Ø«Ø§Ù„: Family Group 1" />
      </div>

      <div class="field">
        <label>Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
        <input type="text" id="f-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" />
      </div>

      <div class="field">
        <label>Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</label>
        <input type="tel" id="f-phone" placeholder="07xxxxxxxxx" />
      </div>

      <div class="field">
        <label>Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø²Ø¨ÙˆÙ† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input type="email" id="f-email" placeholder="customer@example.com" style="direction:ltr; text-align:right;" />
      </div>

      <div class="field">
        <label>Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ø³Ø±ÙŠ - Ù„Ø§ ÙŠØ¸Ù‡Ø± Ù„Ù„Ø²Ø¨ÙˆÙ†)</label>
        <input type="email" id="f-space-email" placeholder="space@example.com" style="direction:ltr; text-align:right;" />
      </div>

      <div class="field">
        <label>Ø±Ù…Ø² / ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ø³Ø±ÙŠ - Ù„Ø§ ÙŠØ¸Ù‡Ø± Ù„Ù„Ø²Ø¨ÙˆÙ†)</label>
        <input type="text" id="f-space-code" placeholder="Ù…Ø«Ø§Ù„: P@ss1234" style="direction:ltr; text-align:right;" />
      </div>

      <div style="display:flex; gap:10px;">
        <div class="field" style="flex:1">
          <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯ÙŠÙ†Ø§Ø±)</label>
          <input type="number" id="f-price" value="10000" />
        </div>
        <div class="field" style="flex:1">
          <label>Ø§Ù„Ù…Ø¯Ø©</label>
          <select id="f-duration" disabled>
            <option value="1">Ø´Ù‡Ø±ÙŠ</option>
          </select>
        </div>
      </div>

      <div style="display:flex; gap:10px;">
        <div class="field" style="flex:1">
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</label>
          <input type="date" id="f-start" onchange="updateDate()" />
        </div>
        <div class="field" style="flex:1">
          <label>Ø§Ù„Ù†Ù‡Ø§ÙŠØ© (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</label>
          <input type="date" id="f-end" />
        </div>
      </div>

      <button class="btn-main" onclick="save()">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>

    <div class="search-area" style="display:flex; gap:8px; margin-bottom:14px;">
      <input type="text" id="q" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø­Ø©..." oninput="render()" style="padding:12px; flex:1" />
      <button style="padding:0 15px; border-radius:12px; border:1px solid rgba(236,72,153,0.18); background:var(--card); color:white; font-weight:900;" onclick="render()">ğŸ”</button>
    </div>

    <div class="filter-title">
      <b id="filter-title">ÙƒÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</b>
      <span id="filter-subtitle">0</span>
    </div>

    <div id="list"></div>
  </div>

  <div id="hidden-area">
    <div id="receipt-box" class="receipt">
      <h2>Subscription Lady</h2>
      <div id="receipt-data"></div>
      <div class="receipt-footer">
        <div class="thank-you-msg">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø®ØªÙŠØ§Ø±ÙƒÙ… Subscription Lady</div>
        <div style="font-size:1.45rem; color:rgba(17,24,39,0.85); font-weight:900;">Ù„Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ (ÙˆØ§ØªØ³Ø§Ø¨):</div>
        <div class="contact-info">07735812377</div>
        <div id="r-date" class="receipt-date"></div>
      </div>
    </div>
  </div>

  <div id="edit-overlay" class="modal-overlay" onclick="closeEditIfOutside(event)">
    <div class="modal" role="dialog" aria-modal="true" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ</div>
        <button class="modal-close" onclick="closeEdit()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>

      <div class="modal-grid">
        <div class="field">
          <label>Ø§Ù„Ø®Ø¯Ù…Ø©</label>
          <select id="e-service">
            <option value="ChatGPT Plus">ChatGPT Plus ğŸ¤–</option>
            <option value="Canva Pro">Canva Pro ğŸ¨</option>
            <option value="CapCut Pro">CapCut Pro ğŸ¬</option>
            <option value="Ø¹Ø¶ÙˆÙŠØ© â­">Ø¹Ø¶ÙˆÙŠØ© Ù…Ù…ÙŠØ²Ø© â­</option>
          </select>
        </div>

        <div class="field">
          <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯ÙŠÙ†Ø§Ø±)</label>
          <input type="number" id="e-price" />
        </div>

        <div class="field">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø­Ø©</label>
          <input type="text" id="e-space" />
        </div>

        <div class="field">
          <label>Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
          <input type="text" id="e-name" />
        </div>

        <div class="field">
          <label>Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</label>
          <input type="tel" id="e-phone" />
        </div>

        <div class="field">
          <label>Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
          <input type="email" id="e-email" style="direction:ltr; text-align:right;" />
        </div>

        <div class="field">
          <label>Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ø³Ø±ÙŠ)</label>
          <input type="email" id="e-space-email" style="direction:ltr; text-align:right;" />
        </div>

        <div class="field">
          <label>Ø±Ù…Ø²/ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ø³Ø±ÙŠ)</label>
          <input type="text" id="e-space-code" style="direction:ltr; text-align:right;" />
        </div>

        <div class="field">
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</label>
          <input type="date" id="e-start" />
        </div>

        <div class="field">
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</label>
          <input type="date" id="e-end" />
        </div>
      </div>

      <div class="mini-row">
        <input type="checkbox" id="e-paid" />
        <span>Ù…Ø¯ÙÙˆØ¹</span>

        <div style="flex:1"></div>

        <input type="checkbox" id="e-reminded" />
        <span>ØªÙ… Ø§Ù„ØªØ°ÙƒÙŠØ±</span>
      </div>

      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeEdit()">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn-save" onclick="saveEdit()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
      </div>
    </div>
  </div>

  <div class="tabs-bar">
    <div class="tabs">
      <button id="tab-all" class="tab-btn active" onclick="setFilter('all')">
        <span class="tab-badge success" id="badge-all">0</span>
        <span class="icon">ğŸ‘¥</span>
        <span class="label">Ø§Ù„ÙƒÙ„</span>
      </button>
      <button id="tab-unpaid" class="tab-btn" onclick="setFilter('unpaid')">
        <span class="tab-badge danger" id="badge-unpaid">0</span>
        <span class="icon">ğŸ’¸</span>
        <span class="label">Ù„Ù… ÙŠØ¯ÙØ¹</span>
      </button>
      <button id="tab-soon" class="tab-btn" onclick="setFilter('soon')">
        <span class="tab-badge warning" id="badge-soon">0</span>
        <span class="icon">â³</span>
        <span class="label">Ù‚Ø±ÙŠØ¨</span>
      </button>
      <button id="tab-expired" class="tab-btn" onclick="setFilter('expired')">
        <span class="tab-badge danger" id="badge-expired">0</span>
        <span class="icon">â›”</span>
        <span class="label">Ù…Ù†ØªÙ‡ÙŠ</span>
      </button>
    </div>
  </div>

  <script>
    /*********************************************************************
     *  âœ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ (Google) Ø¹Ø¨Ø± Firebase:
     *
     *  1) Ø§ÙØªØ­ Firebase Console ÙˆØ³ÙˆÙ‘ÙŠ Project
     *  2) Authentication > Sign-in method > ÙØ¹Ù‘Ù„ Google
     *  3) Firestore Database > Create database
     *  4) Project settings > General > Your apps (Web) > Ø§Ù†Ø³Ø® firebaseConfig
     *  5) Ø¶Ø¹ firebaseConfig Ù‡Ù†Ø§ Ø¨Ø§Ù„Ø¶Ø¨Ø·
     *
     *  Ù…Ù„Ø§Ø­Ø¸Ø©:
     *  - Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙŠÙƒÙˆÙ† Ø¯Ø§Ø®Ù„ Firestore ÙÙŠ Document Ø®Ø§Øµ Ø¨ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… (UID)
     *********************************************************************/
    const firebaseConfig = {
      // Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù‡Ù†Ø§ (Ù…Ù‡Ù…Ø©)
      apiKey: "PUT_YOUR_API_KEY",
      authDomain: "PUT_YOUR_AUTH_DOMAIN",
      projectId: "PUT_YOUR_PROJECT_ID",
      storageBucket: "PUT_YOUR_STORAGE_BUCKET",
      messagingSenderId: "PUT_YOUR_SENDER_ID",
      appId: "PUT_YOUR_APP_ID"
    };

    let firebaseReady = false;
    let auth = null;
    let dbCloud = null;
    let currentUser = null;

    // Debounce for cloud saves
    let cloudSaveTimer = null;
    let cloudLoadingNow = false;
    let lastCloudWriteAt = 0;

    function initFirebaseIfConfigured(){
      // Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø§ ØºÙŠÙ‘Ø± Ø§Ù„Ù‚ÙŠÙ…ØŒ Ù†Ø®Ù„ÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ´ØªØºÙ„ Ù…Ø­Ù„ÙŠ Ø¨Ø¯ÙˆÙ† ÙƒØ±Ø§Ø´
      const looksConfigured =
        firebaseConfig &&
        firebaseConfig.apiKey && !firebaseConfig.apiKey.includes("PUT_") &&
        firebaseConfig.projectId && !firebaseConfig.projectId.includes("PUT_");

      if (!looksConfigured){
        setCloudUI(null, "LOCAL", "Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ.");
        return;
      }

      try{
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        dbCloud = firebase.firestore();
        firebaseReady = true;

        auth.onAuthStateChanged(async (user) => {
          currentUser = user || null;
          if (currentUser){
            setCloudUI(currentUser, "CLOUD", "ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ. Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø£ÙŠ ØªØºÙŠÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.");
            await loadFromCloud(); // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            render();
          } else {
            setCloudUI(null, "LOCAL", "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹. Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Google Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ.");
          }
        });
      } catch(e){
        firebaseReady = false;
        setCloudUI(null, "LOCAL", "ÙØ´Ù„ ØªÙØ¹ÙŠÙ„ Firebase. ØªØ£ÙƒØ¯ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª config.");
      }
    }

    function setCloudUI(user, mode, hint){
      document.getElementById("cloud-pill").innerText = mode || "LOCAL";
      document.getElementById("cloud-hint").innerText = hint || "";
      if (user){
        const name = user.displayName || "Google User";
        const email = user.email || "";
        document.getElementById("cloud-user").innerText = `Ù…Ø±Ø­Ø¨Ø§Ù‹: ${name} ${email ? "â€” " + email : ""}`;
      } else {
        document.getElementById("cloud-user").innerText = "ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„";
      }
    }

    async function signInWithGoogle(){
      if (!firebaseReady) {
        alert("Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ ØºÙŠØ± Ù…ÙØ¹Ù„. Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª firebaseConfig Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }
      try{
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
      } catch(e){
        // Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ ÙŠØ­ØªØ§Ø¬ redirect
        try{
          const provider = new firebase.auth.GoogleAuthProvider();
          await auth.signInWithRedirect(provider);
        } catch(err){
          alert("ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Google. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        }
      }
    }

    async function signOutGoogle(){
      if (!firebaseReady || !auth) return;
      await auth.signOut();
    }

    function cloudDocRef(){
      // Document Ø«Ø§Ø¨Øª Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…
      return dbCloud.collection("subscriptionLady").doc(currentUser.uid);
    }

    async function loadFromCloud(){
      if (!firebaseReady || !currentUser) return;

      cloudLoadingNow = true;
      try{
        const snap = await cloudDocRef().get();
        if (snap.exists){
          const data = snap.data() || {};
          if (Array.isArray(data.db)){
            db = data.db;
            localStorage.setItem('cheap_store_m_db', JSON.stringify(db)); // Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø­Ù„ÙŠ Ø£ÙŠØ¶Ø§Ù‹
          }
        } else {
          // Ø£ÙˆÙ„ Ù…Ø±Ø©: Ø§Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø©
          await saveToCloudNow();
        }
      } catch(e){
        // ignore
      } finally {
        cloudLoadingNow = false;
      }
    }

    function scheduleCloudSave(){
      if (!firebaseReady || !currentUser) return;
      if (cloudLoadingNow) return;

      clearTimeout(cloudSaveTimer);
      cloudSaveTimer = setTimeout(() => saveToCloudNow(), 600);
    }

    async function saveToCloudNow(){
      if (!firebaseReady || !currentUser) return;
      if (cloudLoadingNow) return;

      try{
        const now = Date.now();
        lastCloudWriteAt = now;

        // Ø­ÙØ¸ db ÙƒØ§Ù…Ù„Ø© Ø¯Ø§Ø®Ù„ ÙˆØ«ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©
        await cloudDocRef().set({
          db: db,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

      } catch(e){
        // ignore (Ù…Ù…ÙƒÙ† ØªØ¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ù„Ùˆ ØªØ­Ø¨)
      }
    }

    /***********************  App Logic (Original)  ************************/
    let db = JSON.parse(localStorage.getItem('cheap_store_m_db')) || [];
    let currentFilter = 'all';
    let editingId = null;

    function hapticAndClickSound() {
      if (navigator.vibrate) navigator.vibrate(18);
      try {
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (!AudioCtx) return;
        const ctx = new AudioCtx();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.setValueAtTime(880, ctx.currentTime);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.04, ctx.currentTime + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.08);
        o.connect(g);
        g.connect(ctx.destination);
        o.start();
        o.stop(ctx.currentTime + 0.09);
        setTimeout(() => ctx.close().catch(()=>{}), 150);
      } catch (e) {}
    }

    function exportData() {
      if (db.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§");
      const dataStr = JSON.stringify(db, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
      const exportFileDefaultName = 'SubscriptionLady_Backup_' + new Date().toLocaleDateString() + '.json';
      let linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function (e) {
        try {
          const importedDb = JSON.parse(e.target.result);
          if (Array.isArray(importedDb)) {
            if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©ØŸ")) {
              db = importedDb;
              localStorage.setItem('cheap_store_m_db', JSON.stringify(db));
              render();
              scheduleCloudSave(); // âœ… Ø­ÙØ¸ Ù„Ù„Ø³Ø­Ø§Ø¨Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
              alert("ØªÙ…Øª Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…");
            }
          } else alert("ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­!");
        } catch (err) { alert("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù!"); }
      };
      reader.readAsText(file);
    }

    function setInitialDates() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const today = `${year}-${month}-${day}`;
      document.getElementById('f-start').value = today;
      updateDate();
    }

    function updateDate() {
      let startInput = document.getElementById('f-start').value;
      if (!startInput) return;
      let start = new Date(startInput);
      start.setMonth(start.getMonth() + 1);
      const year = start.getFullYear();
      const month = String(start.getMonth() + 1).padStart(2, '0');
      const day = String(start.getDate()).padStart(2, '0');
      document.getElementById('f-end').value = `${year}-${month}-${day}`;
    }

    setInitialDates();

    function normalizeIraqPhone(phone) {
      phone = (phone || "").replace(/\D/g, '');
      if (phone.startsWith('964')) phone = '0' + phone.substring(3);
      else if (phone && !phone.startsWith('0')) phone = '0' + phone;
      return phone;
    }

    function copyText(text) {
      if (!text) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù†Ø³Ø®");
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => alert("ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…")).catch(() => fallbackCopy(text));
      } else fallbackCopy(text);
    }

    function fallbackCopy(text) {
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.left = '0';
      ta.style.top = '0';
      ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      try { document.execCommand('copy'); alert("ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…"); }
      catch (e) { alert("ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø®ØŒ Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§."); }
      document.body.removeChild(ta);
    }

    function copySpaceEmail(id) { const c = db.find(x => x.id === id); copyText(c?.spaceEmail || ""); }
    function copySpaceCode(id) { const c = db.find(x => x.id === id); copyText(c?.spaceCode || ""); }

    function openChatGPTLogin(id) {
      const c = db.find(x => x.id === id);
      const bundle = `Space Email: ${c?.spaceEmail || ""}\nSpace Code: ${c?.spaceCode || ""}`;
      if ((c?.spaceEmail && c.spaceEmail.trim() !== "") || (c?.spaceCode && c.spaceCode.trim() !== "")) copyText(bundle);
      else alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ÙŠÙ…ÙŠÙ„/Ø±Ù…Ø² Ù„Ù„Ù…Ø³Ø§Ø­Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø²Ø¨ÙˆÙ†. Ø£Ø¶ÙÙ‡Ø§ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø¬Ø±Ù‘Ø¨.");
      alert("Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨ÙˆØ¶Ø¹ Ø§Ù„ØªØµÙØ­ Ø§Ù„Ù…ØªØ®ÙÙŠ (Incognito) Ù…Ù† ÙƒØ±ÙˆÙ…ØŒ Ø«Ù… Ø§Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ.");
      window.open("https://chatgpt.com", "_blank");
    }

    function contact(id) {
      let c = db.find(x => x.id === id);
      if (!c) return;
      let p = (c.phone || "").replace(/\D/g, '');
      if (p.startsWith('0')) p = '964' + p.substring(1);
      window.open(`https://api.whatsapp.com/send?phone=${p}`, '_blank');
    }

    function save() {
      const name = document.getElementById('f-name').value;
      let phone = document.getElementById('f-phone').value;
      const space = document.getElementById('f-space').value || 'Ø¹Ø§Ù…';
      const email = document.getElementById('f-email').value || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
      const price = document.getElementById('f-price').value;
      const endDate = document.getElementById('f-end').value;
      const spaceEmail = document.getElementById('f-space-email').value || '';
      const spaceCode = document.getElementById('f-space-code').value || '';
      if (!name || !phone || !endDate) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©");
      phone = normalizeIraqPhone(phone);

      const item = {
        id: crypto.randomUUID(),
        name, phone, email, space, spaceEmail, spaceCode,
        service: document.getElementById('f-service').value,
        price: price,
        start: document.getElementById('f-start').value,
        end: endDate,
        paid: false,
        paymentDate: "",
        reminded: false,
        createdAt: new Date().toISOString()
      };

      db.unshift(item);
      localStorage.setItem('cheap_store_m_db', JSON.stringify(db));
      scheduleCloudSave(); // âœ… Ø­ÙØ¸ Ù„Ù„Ø³Ø­Ø§Ø¨Ø©

      document.getElementById('f-name').value = '';
      document.getElementById('f-phone').value = '';
      document.getElementById('f-email').value = '';
      document.getElementById('f-space').value = '';
      document.getElementById('f-space-email').value = '';
      document.getElementById('f-space-code').value = '';

      setInitialDates();
      render();
      window.scrollTo(0, 0);
    }

    function openEdit(id) {
      const i = db.findIndex(x => x.id === id);
      if (i === -1) return;
      const c = db[i];
      editingId = id;

      document.getElementById('e-service').value = c.service || "ChatGPT Plus";
      document.getElementById('e-price').value = parseInt(c.price) || 0;
      document.getElementById('e-space').value = c.space || 'Ø¹Ø§Ù…';
      document.getElementById('e-name').value = c.name || '';
      document.getElementById('e-phone').value = c.phone || '';
      document.getElementById('e-email').value = (c.email && c.email !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') ? c.email : '';
      document.getElementById('e-space-email').value = c.spaceEmail || '';
      document.getElementById('e-space-code').value = c.spaceCode || '';
      document.getElementById('e-start').value = c.start || '';
      document.getElementById('e-end').value = c.end || '';
      document.getElementById('e-paid').checked = !!c.paid;
      document.getElementById('e-reminded').checked = !!c.reminded;

      document.getElementById('edit-overlay').style.display = 'flex';
      setTimeout(() => document.getElementById('e-name').focus(), 10);
    }

    function closeEdit() { editingId = null; document.getElementById('edit-overlay').style.display = 'none'; }
    function closeEditIfOutside(e) { if (e.target && e.target.id === 'edit-overlay') closeEdit(); }

    function saveEdit() {
      if (!editingId) return;
      const i = db.findIndex(x => x.id === editingId);
      if (i === -1) return;

      const name = document.getElementById('e-name').value.trim();
      let phone = document.getElementById('e-phone').value.trim();
      const space = document.getElementById('e-space').value.trim() || 'Ø¹Ø§Ù…';
      const email = document.getElementById('e-email').value.trim() || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
      const spaceEmail = document.getElementById('e-space-email').value.trim();
      const spaceCode = document.getElementById('e-space-code').value.trim();
      const service = document.getElementById('e-service').value;
      const priceNum = parseInt(document.getElementById('e-price').value);
      const start = document.getElementById('e-start').value;
      const end = document.getElementById('e-end').value;
      const paid = document.getElementById('e-paid').checked;
      const reminded = document.getElementById('e-reminded').checked;

      if (!name || !phone || !end) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† + Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ + ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©");
      phone = normalizeIraqPhone(phone);

      db[i].name = name;
      db[i].phone = phone;
      db[i].space = space;
      db[i].email = email;
      db[i].spaceEmail = spaceEmail;
      db[i].spaceCode = spaceCode;
      db[i].service = service;
      db[i].price = isNaN(priceNum) ? (db[i].price || "0") : String(priceNum);
      db[i].start = start || db[i].start;
      db[i].end = end;
      db[i].reminded = reminded;

      const wasPaid = !!db[i].paid;
      db[i].paid = paid;
      if (paid && !wasPaid) db[i].paymentDate = new Date().toISOString();
      else if (!paid) db[i].paymentDate = "";

      localStorage.setItem('cheap_store_m_db', JSON.stringify(db));
      scheduleCloudSave(); // âœ… Ø­ÙØ¸ Ù„Ù„Ø³Ø­Ø§Ø¨Ø©
      closeEdit();
      render();
      alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…");
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const overlay = document.getElementById('edit-overlay');
        if (overlay && overlay.style.display === 'flex') closeEdit();
      }
    });

    function sendSoonReminder(id, daysLeft) {
      let i = db.findIndex(x => x.id === id);
      if (i === -1) return;
      let c = db[i];

      let p = c.phone.replace(/\D/g, '');
      if (p.startsWith('0')) p = '964' + p.substring(1);

      const msg = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… \n` +
        `Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ø²Ø¨ÙˆÙ† Ø¨Ø§Ù‚ÙŠ ${daysLeft} ÙŠÙˆÙ…/Ø£ÙŠØ§Ù… Ø¹Ù„Ù‰ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙÙŠ (${c.service}) Ø¨ØªØ§Ø±ÙŠØ® (${c.end}). \n` +
        `Ø¥Ø°Ø§ ØªØ­Ø¨ ØªØ¬Ø¯Ø¯ Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ø±Ø§Ø³Ù„Ù†Ø§ ÙˆØ§Ø­Ù†Ø§ Ø¨Ø§Ù„Ø®Ø¯Ù…Ø©. \n` +
        `ÙˆØ´ÙƒØ±Ø§Ù‹ Ø¬Ø²ÙŠÙ„Ø§Ù‹ Ø§Ù„Ùƒ`;

      db[i].reminded = true;
      localStorage.setItem('cheap_store_m_db', JSON.stringify(db));
      scheduleCloudSave(); // âœ… Ø­ÙØ¸ Ù„Ù„Ø³Ø­Ø§Ø¨Ø©
      render();

      window.open(`https://api.whatsapp.com/send?phone=${p}&text=${encodeURIComponent(msg)}`, '_blank');
    }

    function renewSubscription(id) {
      let i = db.findIndex(x => x.id === id);
      if (i === -1) return;

      const currentSpace = db[i].space || 'Ø¹Ø§Ù…';
      const currentSpaceEmail = db[i].spaceEmail || '';
      const currentSpaceCode = db[i].spaceCode || '';

      let newSpaceName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø­Ø© (ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡):", currentSpace);
      if (newSpaceName === null) return;

      let newSpaceEmail = prompt("Ø£Ø¯Ø®Ù„ Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø³Ø±ÙŠ (ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡):", currentSpaceEmail);
      if (newSpaceEmail === null) return;

      let newSpaceCode = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±/Ø§Ù„Ø±Ù…Ø² Ù„Ù„Ù…Ø³Ø§Ø­Ø© (ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡):", currentSpaceCode);
      if (newSpaceCode === null) return;

      if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù…Ø¯Ø© Ø´Ù‡Ø± Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…ØŸ")) return;

      if (newSpaceName.trim() !== "") db[i].space = newSpaceName.trim();
      db[i].spaceEmail = (newSpaceEmail || '').trim();
      db[i].spaceCode = (newSpaceCode || '').trim();

      let newStartDate = new Date();
      newStartDate.setHours(0,0,0,0);
      let newEndDate = new Date(newStartDate);
      newEndDate.setMonth(newEndDate.getMonth() + 1);

      const formatDate = (date) => {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      };

      db[i].start = formatDate(newStartDate);
      db[i].end = formatDate(newEndDate);
      db[i].paid = true;
      db[i].paymentDate = new Date().toISOString();
      db[i].reminded = false;

      localStorage.setItem('cheap_store_m_db', JSON.stringify(db));
      scheduleCloudSave(); // âœ… Ø­ÙØ¸ Ù„Ù„Ø³Ø­Ø§Ø¨Ø©
      render();
      alert("ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
    }

    function togglePay(id) {
      let i = db.findIndex(x => x.id === id);
      if (i === -1) return;
      db[i].paid = !db[i].paid;
      db[i].paymentDate = db[i].paid ? new Date().toISOString() : "";
      localStorage.setItem('cheap_store_m_db', JSON.stringify(db));
      scheduleCloudSave(); // âœ… Ø­ÙØ¸ Ù„Ù„Ø³Ø­Ø§Ø¨Ø©
      render();
    }

    function del(id) {
      if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´ØªØ±ÙƒØŸ")) {
        db = db.filter(x => x.id !== id);
        localStorage.setItem('cheap_store_m_db', JSON.stringify(db));
        scheduleCloudSave(); // âœ… Ø­ÙØ¸ Ù„Ù„Ø³Ø­Ø§Ø¨Ø©
        render();
      }
    }

    function wa(id) {
      let c = db.find(x => x.id === id);
      if (!c) return;
      let p = c.phone.replace(/\D/g, '');
      if (p.startsWith('0')) p = '964' + p.substring(1);

      let msg = `*Subscription Lady*\n\n` +
        `ğŸ‘¤ Ø§Ù„Ø²Ø¨ÙˆÙ†: ${c.name}\n` +
        `ğŸš€ Ø§Ù„Ù…Ø³Ø§Ø­Ø©: ${c.space || 'Ø¹Ø§Ù…'}\n` +
        `ğŸ›  Ø§Ù„Ø®Ø¯Ù…Ø©: ${c.service}\n` +
        `ğŸ“§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„: ${c.email}\n` +
        `ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: ${parseInt(c.price).toLocaleString()} Ø¯.Ø¹\n` +
        `ğŸ“… ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ: ${c.end}\n` +
        `ğŸ’³ Ø§Ù„Ø­Ø§Ù„Ø©: ${c.paid ? 'ØªÙ… Ø§Ù„Ø¯ÙØ¹ âœ…' : 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹ âŒ'}`;

      window.open(`https://api.whatsapp.com/send?phone=${p}&text=${encodeURIComponent(msg)}`, '_blank');
    }

    function snap(id) {
      let c = db.find(x => x.id === id);
      if (!c) return;

      document.getElementById('r-date').innerText = "ØªØ­Ø±ÙŠØ±Ø§Ù‹ ÙÙŠ: " + new Date().toLocaleDateString('ar-EG');

      document.getElementById('receipt-data').innerHTML = `
        <div class="receipt-row"><span>ğŸ‘¤ Ø§Ù„Ø²Ø¨ÙˆÙ†:</span> <b>${c.name}</b></div>
        <div class="receipt-row"><span>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ:</span> <b style="direction:ltr;">${c.phone}</b></div>
        <div class="receipt-row"><span>ğŸ›  Ø§Ù„Ø®Ø¯Ù…Ø©:</span> <b>${c.service}</b></div>
        <div class="receipt-row"><span>ğŸš€ Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</span> <b>${c.space || 'Ø¹Ø§Ù…'}</b></div>
        <div class="receipt-row"><span>ğŸ“§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:</span> <b style="direction:ltr;">${c.email}</b></div>
        <div class="receipt-row"><span>ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº:</span> <b style="color:#111827;">${parseInt(c.price).toLocaleString()} Ø¯.Ø¹</b></div>
        <div class="receipt-row"><span>ğŸ“… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</span> <b style="color:#111827;">${c.end}</b></div>
        <div class="receipt-row"><span>ğŸ’³ Ø§Ù„Ø­Ø§Ù„Ø©:</span> <b style="color:${c.paid ? '#059669' : '#111827'};">${c.paid ? 'ØªÙ… Ø§Ù„Ø¯ÙØ¹ âœ…' : 'Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø¯ÙØ¹ â³'}</b></div>
      `;

      const target = document.getElementById('receipt-box');

      requestAnimationFrame(() => {
        html2canvas(target, {
          // âœ… Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙˆØµÙ„ (ÙˆØªØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ ÙˆØ¶ÙˆØ­ Ø§Ù„ÙƒØªØ§Ø¨Ø©)
          backgroundColor: '#ffe4f1',
          scale: 3,
          useCORS: true,
          allowTaint: true
        }).then(canvas => {
          const safeName = (c.name || 'Ø²Ø¨ÙˆÙ†').replace(/[\\/:*?"<>|]/g, '-');
          const filename = `ÙˆØµÙ„-${safeName}.png`;

          canvas.toBlob((blob) => {
            if (!blob) {
              let a = document.createElement('a');
              a.download = filename;
              a.href = canvas.toDataURL("image/png");
              a.click();
              return;
            }
            const url = URL.createObjectURL(blob);
            let a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            setTimeout(() => URL.revokeObjectURL(url), 1500);
          }, "image/png");
        }).catch(() => alert("ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© Ø§Ù„ÙˆØµÙ„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."));
      });
    }

    function buildCard(c, flags) {
      const { isExpired, isSoon, daysLeft } = flags;

      let renewBtnHtml = '';
      if (isSoon || isExpired) {
        renewBtnHtml = `<div class="action-btn bg-renew" style="grid-column: span 4; margin-bottom: 8px;" onclick="renewSubscription('${c.id}')">ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù…Ø¯Ø© Ø´Ù‡Ø± ğŸ”„</div>`;
      }

      let reminderBtnHtml = '';
      if (isSoon) {
        if (c.reminded) {
          reminderBtnHtml = `<div class="action-btn bg-reminded" style="grid-column: span 4; margin-bottom: 8px;">ØªÙ… Ø§Ù„ØªØ°ÙƒÙŠØ± âœ…</div>`;
        } else {
          reminderBtnHtml = `<div class="action-btn bg-warning" style="grid-column: span 4; margin-bottom: 8px;" onclick="sendSoonReminder('${c.id}', ${daysLeft})">Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ± (ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ ${daysLeft} ÙŠÙˆÙ…) ğŸ’¬</div>`;
        }
      }

      let spaceSecretHtml = '';
      const hasSpaceSecrets = (c.spaceEmail && c.spaceEmail.trim() !== "") || (c.spaceCode && c.spaceCode.trim() !== "");
      if (hasSpaceSecrets) {
        spaceSecretHtml = `
          <div class="action-btn" style="grid-column: span 4; background:#0b0612; border:1px solid rgba(236,72,153,0.18); color:rgba(255,255,255,0.92); cursor: default;">
            ğŸ” Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ø³Ø±ÙŠÙ‘Ø©):
            <span style="direction:ltr; unicode-bidi:plaintext; font-weight:900; color:#fff;">
              ${c.spaceEmail ? c.spaceEmail : 'â€”'}${c.spaceCode ? ' / ' + c.spaceCode : ''}
            </span>
          </div>
          <div class="action-btn" style="background:#db2777;" onclick="copySpaceEmail('${c.id}')">Ù†Ø³Ø® Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</div>
          <div class="action-btn" style="background:#f472b6;" onclick="copySpaceCode('${c.id}')">Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²</div>
          <div class="action-btn" style="background:#22c55e;" onclick="openChatGPTLogin('${c.id}')">Ø¯Ø®ÙˆÙ„ ChatGPT</div>
          <div class="action-btn" style="background:#1f0f2e; cursor: default;">Ø³Ø±ÙŠ</div>
        `;
      } else {
        spaceSecretHtml = `
          <div class="action-btn" style="grid-column: span 4; background:#0b0612; border:1px dashed rgba(236,72,153,0.22); color:rgba(255,255,255,0.70); cursor: default;">
            ğŸ” Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ø³Ø±ÙŠÙ‘Ø©): ØºÙŠØ± Ù…Ø¶Ø§ÙØ©
          </div>
          <div class="action-btn" style="background:#db2777;" onclick="copySpaceEmail('${c.id}')">Ù†Ø³Ø® Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</div>
          <div class="action-btn" style="background:#f472b6;" onclick="copySpaceCode('${c.id}')">Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²</div>
          <div class="action-btn" style="background:#22c55e;" onclick="openChatGPTLogin('${c.id}')">Ø¯Ø®ÙˆÙ„ ChatGPT</div>
          <div class="action-btn" style="background:#1f0f2e; cursor: default;">Ø³Ø±ÙŠ</div>
        `;
      }

      const currentPrice = parseInt(c.price) || 0;
      const card = document.createElement('div');
      card.className = `customer-card ${isExpired ? 'expired' : ''} ${isSoon ? 'warning-near' : ''} ${(c.service || "").includes('â­') ? 'special' : ''}`;

      let topBanner = '';
      if (isSoon) topBanner = `<div class="reminder-banner">ğŸ”” ØªÙ†Ø¨ÙŠÙ‡: ÙŠÙ†ØªÙ‡ÙŠ Ø§Ø´ØªØ±Ø§Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø²Ø¨ÙˆÙ† Ø®Ù„Ø§Ù„ ${daysLeft} ÙŠÙˆÙ…/Ø£ÙŠØ§Ù…!</div>`;
      if (isExpired) topBanner = `<div class="expired-banner">â›” ØªÙ†Ø¨ÙŠÙ‡: Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù†ØªÙ‡ÙŠ</div>`;

      card.innerHTML = `
        ${topBanner}
        <div class="card-top">
          <div class="cust-name">${c.name}</div>
          <div class="cust-service">${c.service}</div>
        </div>
        <div class="card-info">
          <div>ğŸš€ Ø§Ù„Ù…Ø³Ø§Ø­Ø©: <b>${c.space || 'Ø¹Ø§Ù…'}</b></div>
          <div>ğŸ“§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„: <span class="email-text">${c.email}</span></div>
          <div>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: <b>${c.phone}</b></div>
          <div>ğŸ“… ÙŠÙ†ØªÙ‡ÙŠ: <b style="color:${isExpired ? 'var(--danger)' : (isSoon ? 'var(--warning)' : 'inherit')}">${c.end}</b>
            ${isSoon ? '<span class="status-tag status-warning">Ù‚Ø±ÙŠØ¨ ğŸ””</span>' : ''}
            ${isExpired ? '<span class="status-tag status-unpaid">Ù…Ù†ØªÙ‡ÙŠ â›”</span>' : ''}
          </div>
          <div>ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: ${currentPrice.toLocaleString()} Ø¯.Ø¹
            <span class="status-tag ${c.paid ? 'status-paid' : 'status-unpaid'}">${c.paid ? 'Ù…Ø¯ÙÙˆØ¹' : 'Ù„Ù… ÙŠØ¯ÙØ¹'}</span>
          </div>
        </div>
        <div class="card-actions">
          ${renewBtnHtml}
          ${reminderBtnHtml}
          ${spaceSecretHtml}

          <div class="action-btn bg-edit" onclick="openEdit('${c.id}')">ØªØ¹Ø¯ÙŠÙ„ âœï¸</div>
          <div class="action-btn bg-pay" onclick="togglePay('${c.id}')">${c.paid ? 'Ø¥Ù„ØºØ§Ø¡ Ø¯ÙØ¹' : 'ØªØ£ÙƒÙŠØ¯ Ø¯ÙØ¹'}</div>
          <div class="action-btn bg-contact" onclick="contact('${c.id}')">ØªÙˆØ§ØµÙ„</div>
          <div class="action-btn bg-whatsapp" onclick="wa('${c.id}')">ÙˆØ§ØªØ³</div>

          <div class="action-btn bg-img" onclick="snap('${c.id}')">ÙˆØµÙ„</div>
          <div class="action-btn bg-del" onclick="del('${c.id}')">Ø­Ø°Ù</div>
        </div>
      `;
      return card;
    }

    function computeFlags(c, todayStart) {
      const endDate = new Date(c.end);
      endDate.setHours(0,0,0,0);
      const msDay = 24 * 60 * 60 * 1000;
      const diffDays = Math.round((endDate.getTime() - todayStart.getTime()) / msDay);
      const isExpired = diffDays < 0;
      const isSoon = diffDays >= 0 && diffDays <= 3;
      return { isExpired, isSoon, daysLeft: diffDays };
    }

    function setFilter(filter) {
      hapticAndClickSound();
      currentFilter = filter;
      ['all','unpaid','soon','expired'].forEach(t => {
        const el = document.getElementById('tab-' + t);
        if (el) el.classList.toggle('active', t === filter);
      });
      render();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function render() {
      const q = (document.getElementById('q').value || "").toLowerCase();
      const list = document.getElementById('list');
      list.innerHTML = '';

      let totalMoney = 0, todayMoney = 0, totalDebt = 0;
      let monthMoney = 0, weekMoney = 0, yesterdayMoney = 0;
      let expiredCount = 0, soonCount = 0, unpaidCount = 0;

      const now = new Date();
      const todayStr = now.toISOString().split('T')[0];

      const todayStart = new Date(); todayStart.setHours(0,0,0,0);

      const yesterdayStart = new Date(todayStart);
      yesterdayStart.setDate(yesterdayStart.getDate() - 1);
      const yesterdayStr = yesterdayStart.toISOString().split('T')[0];

      const monthStart = new Date(todayStart.getFullYear(), todayStart.getMonth(), 1);
      monthStart.setHours(0,0,0,0);

      const last7Start = new Date(todayStart);
      last7Start.setDate(last7Start.getDate() - 6);
      last7Start.setHours(0,0,0,0);

      db.forEach(c => {
        const price = parseInt(c.price) || 0;

        if (c.paid) {
          totalMoney += price;

          if (c.paymentDate) {
            const payDate = new Date(c.paymentDate);
            payDate.setHours(0,0,0,0);
            const payStr = c.paymentDate.split('T')[0];

            if (payStr === todayStr) todayMoney += price;
            if (payStr === yesterdayStr) yesterdayMoney += price;
            if (payDate >= last7Start && payDate <= todayStart) weekMoney += price;
            if (payDate >= monthStart) monthMoney += price;
          }
        } else {
          totalDebt += price; unpaidCount++;
        }

        const flags = computeFlags(c, todayStart);
        if (flags.isExpired) expiredCount++;
        if (flags.isSoon) soonCount++;
      });

      document.getElementById('badge-all').innerText = db.length;
      document.getElementById('badge-unpaid').innerText = unpaidCount;
      document.getElementById('badge-soon').innerText = soonCount;
      document.getElementById('badge-expired').innerText = expiredCount;

      document.getElementById('stat-count').innerText = db.length;
      document.getElementById('stat-money').innerText = totalMoney.toLocaleString() + " Ø¯.Ø¹";
      document.getElementById('stat-today-money').innerText = todayMoney.toLocaleString() + " Ø¯.Ø¹";
      document.getElementById('stat-yesterday-money').innerText = yesterdayMoney.toLocaleString() + " Ø¯.Ø¹";
      document.getElementById('stat-week-money').innerText = weekMoney.toLocaleString() + " Ø¯.Ø¹";
      document.getElementById('stat-month-money').innerText = monthMoney.toLocaleString() + " Ø¯.Ø¹";
      document.getElementById('stat-debt').innerText = totalDebt.toLocaleString() + " Ø¯.Ø¹";
      document.getElementById('stat-expired').innerText = expiredCount;
      document.getElementById('stat-need-reminder').innerText = soonCount;

      const titleMap = {
        all: "ÙƒÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†",
        unpaid: "Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù„Ù… ÙŠØ¯ÙØ¹ÙˆØ§",
        soon: "Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø§Ù„Ø°ÙŠÙ† ÙŠÙ†ØªÙ‡ÙŠ Ø§Ø´ØªØ±Ø§ÙƒÙ‡Ù… Ù‚Ø±ÙŠØ¨Ø§Ù‹",
        expired: "Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ø§Ù†ØªÙ‡Ù‰ Ø§Ø´ØªØ±Ø§ÙƒÙ‡Ù…"
      };
      document.getElementById('filter-title').innerText = titleMap[currentFilter] || "ÙƒÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†";

      let shown = 0;
      db.forEach(c => {
        const flags = computeFlags(c, todayStart);
        const match =
          (c.name || "").toLowerCase().includes(q) ||
          (c.email || "").toLowerCase().includes(q) ||
          (c.space || "").toLowerCase().includes(q) ||
          (c.service || "").toLowerCase().includes(q);
        if (!match) return;

        let pass = true;
        if (currentFilter === 'unpaid') pass = !c.paid;
        else if (currentFilter === 'soon') pass = flags.isSoon;
        else if (currentFilter === 'expired') pass = flags.isExpired;
        if (!pass) return;

        list.appendChild(buildCard(c, flags));
        shown++;
      });

      document.getElementById('filter-subtitle').innerText = `${shown} Ù†ØªÙŠØ¬Ø©`;
      if (shown === 0) {
        const div = document.createElement('div');
        div.className = 'empty';
        div.innerText = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…";
        list.appendChild(div);
      }
    }

    // ØªØ´ØºÙŠÙ„
    initFirebaseIfConfigured();
    render();
  </script>
</body>
</html>